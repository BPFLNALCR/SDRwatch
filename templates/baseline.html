{% extends "base.html" %}
{% block content %}
<section class="card space-y-4">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h2 class="text-lg font-semibold">Baseline bins</h2>
      {% if selected_baseline %}
        <div class="text-xs muted">#{{ selected_baseline.id }} · {{ selected_baseline.name }} · {{ '%.3f' % (selected_baseline.freq_start_hz/1e6) }}–{{ '%.3f' % (selected_baseline.freq_stop_hz/1e6) }} MHz</div>
      {% else %}
        <div class="text-xs muted">Create a baseline to populate persistent stats.</div>
      {% endif %}
    </div>
    {% if freq_span_label %}
      <div class="text-xs text-cyan-200">Window {{ freq_span_label }}</div>
    {% endif %}
  </div>

  <form class="grid grid-cols-1 md:grid-cols-5 gap-3" method="get" action="/baseline">
    <div class="field">
      <label class="text-[0.65rem] uppercase tracking-wide">Baseline</label>
      <select class="input" name="baseline_id" {% if not baselines %}disabled{% endif %}>
        {% if baselines %}
          {% for b in baselines %}
            <option value="{{ b.id }}" {% if selected_baseline_id == b.id|string %}selected{% endif %}>#{{ b.id }} · {{ b.name }}</option>
          {% endfor %}
        {% else %}
          <option>(no baselines)</option>
        {% endif %}
      </select>
    </div>
    <div class="field">
      <label class="text-[0.65rem] uppercase tracking-wide">Center (MHz)</label>
      <input class="input" type="number" step="0.000001" name="f_mhz" value="{{ req_args.get('f_mhz','') }}" placeholder="e.g. 100.5" />
    </div>
    <div class="field">
      <label class="text-[0.65rem] uppercase tracking-wide">Window ± (kHz)</label>
      <input class="input" type="number" step="1" min="1" name="window_khz" value="{{ req_args.get('window_khz','50') }}" />
    </div>
    <div class="field md:col-span-2 flex items-end">
      <button class="btn w-full justify-center" type="submit">Show bins</button>
    </div>
  </form>

  {% if status_message %}
    {% set status_class = 'text-slate-300' %}
    {% if status_level == 'error' %}
      {% set status_class = 'text-red-300' %}
    {% elif status_level == 'warning' %}
      {% set status_class = 'text-amber-300' %}
    {% else %}
      {% set status_class = 'muted' %}
    {% endif %}
    <div class="text-xs {{ status_class }}">{{ status_message }}</div>
  {% endif %}

  <div class="overflow-x-auto">
    <table class="table text-sm">
      <thead>
        <tr class="text-slate-400">
          <th class="th">Freq (MHz)</th>
          <th class="th">Occ %</th>
          <th class="th">Occ count</th>
          <th class="th">Total windows</th>
          <th class="th">Noise floor (dB)</th>
          <th class="th">Power EMA (dB)</th>
          <th class="th">Last seen (UTC)</th>
        </tr>
      </thead>
      <tbody>
        {% if rows %}
          {% for r in rows %}
            <tr class="hover:bg-white/5">
              <td class="td">{% if r.freq_hz is not none %}{{ '%.6f' % (r.freq_hz/1e6) }}{% else %}—{% endif %}</td>
              <td class="td">{% if r.occ_ratio is not none %}{{ '%.2f' % (r.occ_ratio * 100) }}%{% else %}—{% endif %}</td>
              <td class="td">{{ r.occ_count }}</td>
              <td class="td">{{ r.total_windows }}</td>
              <td class="td">{% if r.noise_floor_ema is not none %}{{ '%.1f' % r.noise_floor_ema }}{% else %}—{% endif %}</td>
              <td class="td">{% if r.power_ema is not none %}{{ '%.1f' % r.power_ema }}{% else %}—{% endif %}</td>
              <td class="td">{{ r.last_seen_utc or '—' }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td class="td" colspan="7">
              {% if baselines and stats_available and req_args.get('f_mhz') %}
                No stats recorded in this window yet.
              {% elif not baselines %}
                Create a baseline to start collecting stats.
              {% else %}
                Enter a center frequency and window to inspect bins.
              {% endif %}
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
