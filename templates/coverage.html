{% extends "base.html" %}
{% block content %}
<section class="space-y-5">
  <div class="card">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-xl font-semibold">Frequency Coverage</h1>
        <p class="muted text-sm">Compare the latest scan histogram with the averaged coverage of all scans under the selected filters.</p>
      </div>
      <div class="text-xs text-slate-300">
        {% if latest_meta %}
        Latest scan ID {{ latest_meta.id }} | span {{ (latest_meta.f_start_hz/1e6)|round(3) }}–{{ (latest_meta.f_stop_hz/1e6)|round(3) }} MHz
        {% else %}
        No recent scan in selection
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card">
    <form method="get" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      <label class="field"><span>Service</span>
        <select class="input" name="service">
          <option value="">(all services)</option>
          {% for svc in services %}
          <option value="{{ svc }}" {% if form_defaults.service == svc %}selected{% endif %}>{{ svc }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field"><span>Min SNR (dB)</span>
        <input class="input" name="min_snr" value="{{ form_defaults.min_snr }}" inputmode="decimal" />
      </label>
      {% if confidence_available %}
      <label class="field"><span>Min confidence</span>
        <input class="input" name="min_conf" value="{{ form_defaults.min_conf }}" inputmode="decimal" />
      </label>
      {% endif %}
      <label class="field"><span>Freq min (MHz)</span>
        <input class="input" name="f_min_mhz" value="{{ form_defaults.f_min_mhz }}" inputmode="decimal" />
      </label>
      <label class="field"><span>Freq max (MHz)</span>
        <input class="input" name="f_max_mhz" value="{{ form_defaults.f_max_mhz }}" inputmode="decimal" />
      </label>
      <label class="field"><span>Lookback (hours)</span>
        <input class="input" name="since_hours" value="{{ form_defaults.since_hours }}" inputmode="numeric" />
      </label>
      <div class="flex items-center gap-2 col-span-full">
        <button class="btn" type="submit">Apply filters</button>
        <a class="btn" style="background:#475569" href="/coverage">Clear</a>
      </div>
    </form>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="stat">
      <div class="text-sm muted">Latest max bin count</div>
      <div class="text-2xl font-semibold">{{ latest_max or 0 }}</div>
      <div class="text-xs muted">Highest bin in latest scan</div>
    </div>
    <div class="stat">
      <div class="text-sm muted">Average max bin</div>
      <div class="text-2xl font-semibold">{{ avg_max or 0 }}</div>
      <div class="text-xs muted">Peak normalized count across scans</div>
    </div>
    <div class="stat">
      <div class="text-sm muted">Average span</div>
      <div class="text-2xl font-semibold">
        {% if avg_start_mhz and avg_stop_mhz %}
        {{ avg_start_mhz|round(3) }}–{{ avg_stop_mhz|round(3) }} MHz
        {% else %}
        —
        {% endif %}
      </div>
      <div class="text-xs muted">All-scans coverage window</div>
    </div>
  </div>

  <div class="card">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">Latest scan bins</h2>
      {% if latest_meta %}
      <div class="text-xs text-slate-300">Scan {{ latest_meta.id }} · {{ latest_meta.t_start_utc or '—' }}</div>
      {% endif %}
    </div>
    {% if latest_bins %}
    <div class="overflow-x-auto">
      <div class="flex items-end gap-1 min-h-[160px] py-3">
        {% for bin in latest_bins %}
        <div class="flex flex-col items-center gap-1 min-w-[30px]">
          <div class="w-4 bg-sky-400 rounded" {{ bin.style_attr|safe }}></div>
          <div class="text-[0.55rem] text-slate-400">{{ bin.count }}</div>
          <div class="text-[0.55rem] text-slate-500">{{ bin.mhz_start|round(1) }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <div class="text-sm text-slate-400">No bins to show for the latest scan and filters.</div>
    {% endif %}
  </div>

  <div class="card">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">All scans (avg)</h2>
      {% if avg_start_mhz and avg_stop_mhz %}
      <div class="text-xs text-slate-300">{{ avg_start_mhz|round(3) }}–{{ avg_stop_mhz|round(3) }} MHz</div>
      {% endif %}
    </div>
    {% if avg_bins %}
    <div class="overflow-x-auto">
      <div class="flex items-end gap-1 min-h-[160px] py-3">
        {% for bin in avg_bins %}
        <div class="flex flex-col items-center gap-1 min-w-[30px]">
          <div class="w-4 bg-emerald-300 rounded" {{ bin.style_attr|safe }}></div>
          <div class="text-[0.55rem] text-slate-400">{{ '%.1f'|format(bin.count) }}</div>
          <div class="text-[0.55rem] text-slate-500">{{ bin.mhz_start|round(1) }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <div class="text-sm text-slate-400">No aggregate bins for this selection.</div>
    {% endif %}
  </div>
</section>
{% endblock %}
