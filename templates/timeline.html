{% extends "base.html" %}
{% block content %}
<section class="space-y-5">
  <div class="card">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-xl font-semibold">Timeline</h1>
        <p class="muted text-sm">Historical detections and scans aggregated into hourly/daily buckets.</p>
      </div>
      <div class="text-sm text-slate-300">
        {% if time_span %}
        <span class="muted">Span:</span> {{ time_span }} (bucket {{ timeline.bucket_hours }}h)
        {% else %}
        <span class="muted">Span:</span> —
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card">
    <form method="get" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      <label class="field"><span>Service</span>
        <select class="input" name="service">
          <option value="">(all services)</option>
          {% for svc in services %}
          <option value="{{ svc }}" {% if form_defaults.service == svc %}selected{% endif %}>{{ svc }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field"><span>Min SNR (dB)</span>
        <input class="input" name="min_snr" value="{{ form_defaults.min_snr }}" inputmode="decimal" />
      </label>
      {% if confidence_available %}
      <label class="field"><span>Min confidence</span>
        <input class="input" name="min_conf" value="{{ form_defaults.min_conf }}" inputmode="decimal" />
      </label>
      {% endif %}
      <label class="field"><span>Freq min (MHz)</span>
        <input class="input" name="f_min_mhz" value="{{ form_defaults.f_min_mhz }}" inputmode="decimal" />
      </label>
      <label class="field"><span>Freq max (MHz)</span>
        <input class="input" name="f_max_mhz" value="{{ form_defaults.f_max_mhz }}" inputmode="decimal" />
      </label>
      <label class="field"><span>Lookback (hours)</span>
        <input class="input" name="since_hours" value="{{ form_defaults.since_hours }}" inputmode="numeric" />
      </label>
      <div class="flex items-center gap-2 col-span-full">
        <button class="btn" type="submit">Apply filters</button>
        <a class="btn" style="background:#475569" href="/timeline">Clear</a>
      </div>
    </form>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="stat">
      <div class="text-sm muted">Filtered detections</div>
      <div class="text-2xl font-semibold">{{ "{:,}".format(detection_total) }}</div>
      <div class="text-xs muted">From current filters</div>
    </div>
    <div class="stat">
      <div class="text-sm muted">Buckets shown</div>
      <div class="text-2xl font-semibold">{{ bucket_count }}</div>
      <div class="text-xs muted">Total windows plotted</div>
    </div>
    <div class="stat">
      <div class="text-sm muted">Sum across buckets</div>
      <div class="text-2xl font-semibold">{{ "{:,}".format(bucket_sum) }}</div>
      <div class="text-xs muted">Σ detections in timeline</div>
    </div>
    <div class="stat">
      <div class="text-sm muted">Max per bucket</div>
      <div class="text-2xl font-semibold">{{ timeline.det_max }}</div>
      <div class="text-xs muted">Detections in busiest bucket</div>
    </div>
  </div>

  <div class="card">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">Detections vs scans</h2>
      <div class="flex items-center gap-3 text-xs">
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-sky-400 inline-block"></span>Detections</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-400/80 inline-block"></span>Scans</span>
        <span class="flex items-center gap-1"><span class="w-2 h-3 rounded bg-orange-400 inline-block"></span>Max SNR</span>
      </div>
    </div>
    {% if timeline.buckets %}
    <div class="overflow-x-auto">
      <div class="flex items-end gap-2 min-h-[180px] py-4">
        {% for bucket in timeline.buckets %}
        <div class="flex flex-col items-center gap-1 min-w-[46px]">
          <div class="flex items-end gap-1">
            <div class="w-6 bg-sky-400 rounded" style="height: {{ bucket.det_height }}px;"></div>
            <div class="w-4 bg-emerald-400/80 rounded" style="height: {{ bucket.scan_height }}px;"></div>
            <div class="w-2 bg-orange-400 rounded" style="height: {{ bucket.snr_height }}px;"></div>
          </div>
          <div class="text-[0.6rem] text-slate-400 whitespace-nowrap">{{ bucket.label }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <div class="text-sm text-slate-400">No timeline data for the selected filters.</div>
    {% endif %}
  </div>

  <div class="card">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">SNR distribution</h2>
      {% if snr_stats %}
      <div class="text-xs text-slate-300">p50 {{ snr_stats.p50|round(1) if snr_stats.p50 is not none else "—" }} dB · p90 {{ snr_stats.p90|round(1) if snr_stats.p90 is not none else "—" }} dB</div>
      {% endif %}
    </div>
    {% if hist %}
    <div class="flex items-end gap-2 min-h-[140px]">
      {% for bucket in hist %}
      <div class="flex flex-col items-center gap-1 min-w-[36px]">
        <div class="w-5 bg-slate-300/70 rounded" style="height: {{ bucket.height_px|default(0)|int }}px;"></div>
        <div class="text-[0.6rem] text-slate-400">{{ bucket.label }}</div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-sm text-slate-400">No SNR data in this range.</div>
    {% endif %}
  </div>
</section>
{% endblock %}
