{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  <section class="card space-y-4">
    <div class="flex items-end gap-3 flex-wrap">
      <div class="grow">
        <h2 class="text-lg font-semibold">Detections</h2>
        <div class="text-xs muted">{{ total }} matching · {{ detections_total }} in database</div>
      </div>
      <a class="btn" href="/export/detections.csv{% if qs %}?{{ qs }}{% endif %}">Export CSV</a>
    </div>

    <form class="grid grid-cols-2 md:grid-cols-6 gap-3" method="get" action="/detections">
      <div class="field">
        <label class="text-xs uppercase muted" for="flt-service">Service</label>
        <select name="service" id="flt-service" class="input">
          <option value="">Any</option>
          {% for s in services %}<option value="{{ s }}" {% if form_defaults.service == s %}selected{% endif %}>{{ s }}</option>{% endfor %}
        </select>
      </div>
      <div class="field">
        <label class="text-xs uppercase muted" for="flt-min-snr">Min SNR (dB)</label>
        <input class="input" id="flt-min-snr" type="number" step="0.1" name="min_snr" value="{{ form_defaults.min_snr }}" placeholder="e.g. 10" />
      </div>
      <div class="field">
        <label class="text-xs uppercase muted" for="flt-min-conf">Min confidence</label>
        <select class="input" id="flt-min-conf" name="min_conf" {% if not confidence_available %}disabled{% endif %}>
          <option value="">Any</option>
          {% for opt in [0.3, 0.5, 0.7, 0.85, 0.9] %}
            <option value="{{ '%.2f' % opt }}" {% if form_defaults.min_conf|float == opt %}selected{% endif %}>≥ {{ '%.0f' % (opt*100) }}%</option>
          {% endfor %}
        </select>
        {% if not confidence_available %}<div class="hint text-[11px]">Confidence column missing; filter disabled.</div>{% endif %}
      </div>
      <div class="field">
        <label class="text-xs uppercase muted" for="flt-fmin">Min freq (MHz)</label>
        <input class="input" id="flt-fmin" type="number" step="0.1" name="f_min_mhz" value="{{ form_defaults.f_min_mhz }}" placeholder="Start" />
      </div>
      <div class="field">
        <label class="text-xs uppercase muted" for="flt-fmax">Max freq (MHz)</label>
        <input class="input" id="flt-fmax" type="number" step="0.1" name="f_max_mhz" value="{{ form_defaults.f_max_mhz }}" placeholder="Stop" />
      </div>
      <div class="field">
        <label class="text-xs uppercase muted" for="flt-hours">Lookback (hours)</label>
        <input class="input" id="flt-hours" type="number" step="1" min="1" name="since_hours" value="{{ form_defaults.since_hours }}" placeholder="168" />
      </div>
      <div class="field flex items-end gap-2">
        <button class="btn w-full" type="submit">Apply</button>
        <a class="btn red" href="{{ clear_filters_url }}">Reset</a>
      </div>
    </form>

    <div class="space-y-2 text-xs">
      <div class="flex flex-wrap items-center gap-2">
        <span class="muted">Quick lookback:</span>
        {% for r in quick_ranges %}
          <a class="chip {% if r.active %}chip-active{% endif %}" href="{{ r.href }}">{{ r.label }}</a>
        {% endfor %}
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <span class="muted">Quick SNR:</span>
        {% for s in quick_snrs %}
          <a class="chip {% if s.active %}chip-active{% endif %}" href="{{ s.href }}">{{ s.label }}</a>
        {% endfor %}
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <span class="muted">Band presets:</span>
        {% for b in quick_bands %}
          <a class="chip {% if b.active %}chip-active{% endif %}" href="{{ b.href }}">{{ b.label }}</a>
        {% endfor %}
      </div>
    </div>

    <div class="flex flex-wrap gap-2 text-xs">
      <span class="muted">Filters:</span>
      {% if active_filters %}
        {% for f in active_filters %}
          <span class="chip">{{ f.label }}: {{ f.value }}</span>
        {% endfor %}
      {% else %}
        <span class="chip">Default view</span>
      {% endif %}
    </div>

    <section class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-4">
      {% for card in summary_cards %}
        <div class="stat">
          <div class="text-xs uppercase muted">{{ card.label }}</div>
          <div class="text-2xl font-semibold">{{ card.value }}</div>
          {% if card.subtext %}<div class="text-xs muted mt-1">{{ card.subtext }}</div>{% endif %}
        </div>
      {% endfor %}
    </section>
  </section>

  <section class="grid grid-cols-1 xl:grid-cols-3 gap-4">
    <div class="card xl:col-span-2">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Activity timeline</h2>
        <div class="text-xs muted">{{ 'Hourly buckets' if timeline.bucket_hours == 1 else 'Daily buckets' }}</div>
      </div>
      {% if timeline.buckets %}
        <div class="timeline-scroll">
          <div class="timeline-track-wrapper">
            <div class="chart-grid timeline-grid" {{ chart_style_attr | safe }}>
              <div class="timeline-track">
                {% for b in timeline.buckets %}
                  <div class="timeline-column" title="{{ b.detections }} detections, {{ b.scans }} scans{% if b.max_snr is not none %}, max SNR {{ '%.1f' % b.max_snr }} dB{% endif %}">
                    <div class="timeline-stack">
                      <div class="timeline-det bar" {{ b.det_style_attr | safe }}></div>
                      <div class="timeline-scan bar" {{ b.scan_style_attr | safe }}></div>
                      <div class="timeline-snr bar" {{ b.snr_style_attr | safe }}></div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="timeline-label-row">
              {% for b in timeline.buckets %}
                <span class="timeline-label">{{ b.label }}</span>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="text-[11px] muted mt-2">Blue = detections, green = scans, orange = strongest SNR.</div>
      {% else %}
        <div class="text-sm muted">No activity in range.</div>
      {% endif %}
    </div>
    <div class="card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Top services</h2>
        <div class="text-xs muted">Filtered set</div>
      </div>
      <ul class="space-y-1 text-sm">
        {% for s in top_services %}
          <li class="flex items-center justify-between"><span class="chip">{{ s.service }}</span><span class="text-slate-300">{{ s.count }}</span></li>
        {% else %}
          <li class="text-slate-400">No data.</li>
        {% endfor %}
      </ul>
    </div>
  </section>

  <section class="grid grid-cols-1 xl:grid-cols-2 gap-4">
    <div class="card">
      <div class="flex items-center justify-between mb-2"><h2 class="text-lg font-semibold">SNR distribution</h2><span class="text-xs muted">Bucket 3 dB</span></div>
      {% if snr_stats and snr_hist %}
        <div class="text-xs muted mb-2 flex flex-wrap gap-4">
          <div><span class="muted">Count:</span> {{ snr_stats.count }}</div>
          <div><span class="muted">Median:</span> {{ '%.1f' % snr_stats.p50 }} dB</div>
          <div><span class="muted">p90:</span> {{ '%.1f' % snr_stats.p90 }} dB</div>
          <div><span class="muted">Max:</span> {{ '%.1f' % snr_stats.p100 }} dB</div>
        </div>
        <div class="timeline-scroll snr-scroll">
          <div class="timeline-track-wrapper">
            <div class="chart-grid snr-grid" {{ chart_style_attr | safe }}>
              <div class="timeline-track snr-track">
                {% for b in snr_hist %}
                  <div class="timeline-column snr-column" title="{{ b.count }} detections">
                    <div class="timeline-stack">
                      <div class="bar snr-bar rounded-t" {{ b.style_attr | safe }}></div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="timeline-meta-row snr-meta">
              {% for b in snr_hist %}<span>{{ b.count }}</span>{% endfor %}
            </div>
            <div class="timeline-label-row snr-labels">
              {% for b in snr_hist %}<span>{{ b.label }}</span>{% endfor %}
            </div>
          </div>
        </div>
      {% else %}
        <div class="text-sm muted">No SNR data for the current filters.</div>
      {% endif %}
    </div>
    <div class="card">
      <h2 class="text-lg font-semibold mb-2">Preset helpers</h2>
      <div class="space-y-3 text-sm">
        <div>
          <div class="muted mb-1">Lookback</div>
          <div class="flex flex-wrap gap-2">
            {% for r in quick_ranges %}
              <a class="chip {% if r.active %}chip-active{% endif %}" href="{{ r.href }}">{{ r.label }}</a>
            {% endfor %}
          </div>
        </div>
        <div>
          <div class="muted mb-1">Min SNR</div>
          <div class="flex flex-wrap gap-2">
            {% for s in quick_snrs %}
              <a class="chip {% if s.active %}chip-active{% endif %}" href="{{ s.href }}">{{ s.label }}</a>
            {% endfor %}
          </div>
        </div>
        <div>
          <div class="muted mb-1">Band presets</div>
          <div class="flex flex-wrap gap-2">
            {% for b in quick_bands %}
              <a class="chip {% if b.active %}chip-active{% endif %}" href="{{ b.href }}">{{ b.label }}</a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="flex items-center justify-between mb-3">
      <div>
        <h2 class="text-lg font-semibold">Detection list</h2>
        <div class="text-xs muted">Page {{ page_num }} showing {{ rows|length }} / {{ total }} results</div>
      </div>
    </div>

    <div id="detections-table" class="overflow-x-auto">
      <table class="table">
        <thead><tr class="text-slate-400"><th class="th">Time (UTC)</th><th class="th">Scan</th><th class="th">Center (MHz)</th><th class="th">Low–High (MHz)</th><th class="th">Peak (dB)</th><th class="th">Noise (dB)</th><th class="th">SNR (dB)</th><th class="th">Status</th><th class="th">Confidence</th><th class="th">Service</th><th class="th">Region</th><th class="th">Notes</th></tr></thead>
        <tbody>
          {% for r in rows %}
            <tr class="hover:bg-white/5">
              <td class="td">{{ r.time_utc }}</td><td class="td">{{ r.scan_id }}</td>
              <td class="td">
                {{ (r.f_center_hz/1e6)|round(6) }}
                {% if r.near_spur %}<span class="chip text-amber-300 border border-amber-400/40 text-[11px] ml-1" title="Near known spur bin">spur?</span>{% endif %}
              </td>
              <td class="td">{{ (r.f_low_hz/1e6)|round(6) }}–{{ (r.f_high_hz/1e6)|round(6) }}</td>
              <td class="td">{{ '%.1f' % r.peak_db if r.peak_db is not none else '' }}</td>
              <td class="td">{{ '%.1f' % r.noise_db if r.noise_db is not none else '' }}</td>
              <td class="td">{{ '%.1f' % r.snr_db if r.snr_db is not none else '' }}</td>
              <td class="td">
                {% if r.baseline_status == 'new' %}
                  <span class="chip chip-active text-emerald-200" title="EMA occ &lt; {{ '%.2f' % baseline_threshold }}">New</span>
                {% elif r.baseline_status == 'known' %}
                  <span class="chip text-slate-200" title="EMA occ ≥ {{ '%.2f' % baseline_threshold }}">Known</span>
                {% else %}
                  <span class="chip text-slate-400">Unknown</span>
                {% endif %}
              </td>
              <td class="td">{% if r.confidence is not none %}{{ '%.0f%%' % (r.confidence * 100) }}{% else %}—{% endif %}</td>
              <td class="td"><span class="chip">{{ r.service or 'Unknown' }}</span></td>
              <td class="td">{{ r.region or '' }}</td>
              <td class="td truncate max-w-[24ch]" title="{{ r.notes or '' }}">{{ r.notes or '' }}</td>
            </tr>
          {% else %}<tr><td class="td" colspan="11">No detections found.</td></tr>{% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-3 flex flex-wrap items-center gap-2">
      {% set pages = (total // page_size) + (1 if (total % page_size) else 0) %}
      <div>Page {{ page_num }} / {{ pages if pages else 1 }}</div>
      <form method="get" action="/detections" class="flex items-center gap-2">
        <input type="hidden" name="page_size" value="{{ page_size }}" />
        <input type="hidden" name="service" value="{{ form_defaults.service }}" />
        <input type="hidden" name="min_snr" value="{{ form_defaults.min_snr }}" />
        <input type="hidden" name="min_conf" value="{{ form_defaults.min_conf }}" />
        <input type="hidden" name="f_min_mhz" value="{{ form_defaults.f_min_mhz }}" />
        <input type="hidden" name="f_max_mhz" value="{{ form_defaults.f_max_mhz }}" />
        <input type="hidden" name="since_hours" value="{{ form_defaults.since_hours }}" />
        <button class="btn" name="page" value="{{ 1 if page_num<=1 else page_num-1 }}">Prev</button>
        <button class="btn" name="page" value="{{ pages if page_num>=pages else page_num+1 }}">Next</button>
      </form>
      <form method="get" action="/detections" class="ml-auto flex items-center gap-2">
        <input type="hidden" name="service" value="{{ form_defaults.service }}" />
        <input type="hidden" name="min_snr" value="{{ form_defaults.min_snr }}" />
        <input type="hidden" name="min_conf" value="{{ form_defaults.min_conf }}" />
        <input type="hidden" name="f_min_mhz" value="{{ form_defaults.f_min_mhz }}" />
        <input type="hidden" name="f_max_mhz" value="{{ form_defaults.f_max_mhz }}" />
        <input type="hidden" name="since_hours" value="{{ form_defaults.since_hours }}" />
        <label class="text-xs muted" for="page-size">Rows:</label>
        <select id="page-size" name="page_size" class="input" onchange="this.form.submit()">
          {% for sz in [25,50,100,200] %}
            <option value="{{ sz }}" {% if page_size==sz %}selected{% endif %}>{{ sz }} / page</option>
          {% endfor %}
        </select>
      </form>
    </div>
  </section>
  <div class="text-xs muted space-y-1">
    {% if spur_hint_available %}<div><span class="chip text-amber-300 border border-amber-400/40 text-[11px]">spur?</span> denotes proximity to a known spur bin.</div>{% endif %}
    {% if baseline_hint_available %}<div><span class="chip chip-active text-emerald-200">New</span> uses EMA occupancy &lt; {{ '%.2f' % baseline_threshold }}, else <span class="chip text-slate-200">Known</span>.</div>{% endif %}
  </div>
</div>
{% endblock %}
