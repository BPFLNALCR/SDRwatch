{% macro freq_span_label(baseline) -%}
  {%- if baseline and baseline.freq_start_hz and baseline.freq_stop_hz and baseline.freq_stop_hz > baseline.freq_start_hz -%}
    {{ '%.3f'|format(baseline.freq_start_hz / 1e6) }}–{{ '%.3f'|format(baseline.freq_stop_hz / 1e6) }} MHz
  {%- elif baseline and baseline.freq_stop_hz and baseline.freq_stop_hz > 0 -%}
    ≤ {{ '%.3f'|format(baseline.freq_stop_hz / 1e6) }} MHz
  {%- else -%}
    Auto span (pending scans)
  {%- endif -%}
{%- endmacro %}

{% macro classification_chip(cls) -%}
  {%- if cls == 'friendly' -%}
    <span class="chip text-xs bg-green-600/80 text-green-100">Friendly</span>
  {%- elif cls == 'ambient' -%}
    <span class="chip text-xs bg-slate-500/80 text-slate-100">Ambient</span>
  {%- elif cls == 'hostile' -%}
    <span class="chip text-xs bg-red-600/80 text-red-100">Hostile</span>
  {%- else -%}
    <span class="chip text-xs bg-slate-700/80 text-slate-300">Unknown</span>
  {%- endif -%}
{%- endmacro %}

<div class="space-y-6" id="dashboard-panels">
  <div class="card flex flex-wrap items-center justify-between gap-4">
    <div>
      <div class="text-xs uppercase tracking-wide text-slate-400">Quick navigation</div>
      <div class="text-sm text-slate-200">Jump between tactical views.</div>
    </div>
    <div class="flex flex-wrap gap-2 text-sm" aria-label="Dashboard shortcuts">
      <a href="#baseline-overview" class="chip chip-active">Dashboard</a>
      <a href="/changes" class="chip">Changes</a>
      <a href="/spur-map" class="chip">Spur map</a>
      <a href="/control" class="chip">Control</a>
    </div>
  </div>

  {% if not baselines %}
    <div class="card">
      <h2 class="text-lg font-semibold mb-2">Start with a baseline</h2>
      <p class="text-sm text-slate-300">No baselines are present yet. Create one from the Control page, run a scan tied to that baseline, and this dashboard will populate with baseline stats, deltas, and signal cards.</p>
      <a href="/control" class="btn mt-3 text-sm">Go to Control</a>
    </div>
  {% else %}
    {% set baseline = selected_baseline %}
    {% set snapshot = selected_snapshot %}
    {% set band_summary = selected_tactical.band_summary if selected_tactical else [] %}
    {% set hotspots = selected_hotspots %}
    {% set baseline_summary = selected_baseline_summary or {} %}
    {% set freq_span = freq_span_label(baseline) %}
    {% set last_update = selected_baseline_last_update %}
    <section id="baseline-overview" class="card space-y-5">
      <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="text-xl font-semibold">Baseline overview</h2>
          <p class="text-sm text-slate-300">Understand what “normal” looks like for the active baseline.</p>
        </div>
        <form method="get" class="flex flex-wrap items-center gap-2" data-dashboard-baseline-form>
          <input type="hidden" name="change_filter" value="{{ dashboard_change_filter }}" />
          <label class="text-xs uppercase tracking-wide text-slate-400" for="baseline-select">Baseline</label>
          <select id="baseline-select" name="baseline_id" class="input" data-dashboard-baseline-select>
            {% for b in baselines %}
              <option value="{{ b.id }}" {% if selected_baseline_id == b.id|string %}selected{% endif %}>#{{ b.id }} · {{ b.name }} ({{ freq_span_label(b) }})</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn text-xs" data-dashboard-refresh>Refresh</button>
        </form>
      </div>

      {% if baseline %}
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
          <div class="border border-white/10 rounded-xl p-4 bg-white/5">
            <div class="text-xs uppercase tracking-wide muted">Baseline</div>
            <div class="text-lg font-semibold">#{{ baseline.id }} · {{ baseline.name }}</div>
            <div class="text-xs text-slate-400">{{ freq_span }}</div>
          </div>
          <div class="border border-white/10 rounded-xl p-4 bg-white/5">
            <div class="text-xs uppercase tracking-wide muted">Total windows</div>
            <div class="text-2xl font-semibold">{{ baseline_summary.total_windows or baseline.total_windows or 0 }}</div>
            <div class="text-xs text-slate-400">derived from scan updates</div>
          </div>
          <div class="border border-white/10 rounded-xl p-4 bg-white/5">
            <div class="text-xs uppercase tracking-wide muted">Persistent signals</div>
            <div class="text-2xl font-semibold">{{ baseline_summary.persistent_detections or (snapshot.persistent_signals if snapshot else 0) }}</div>
            <div class="text-xs text-slate-400">updated per sweep</div>
          </div>
          <div class="border border-white/10 rounded-xl p-4 bg-white/5">
            <div class="text-xs uppercase tracking-wide muted">Last update</div>
            <div class="text-lg font-semibold">{{ format_ts_label(last_update) }}</div>
            <div class="text-xs text-slate-400">{{ snapshot.recent_new if snapshot else 0 }} new in {{ snapshot.recent_window_minutes if snapshot else tactical_config.recent_new_minutes }} min</div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <h3 class="text-sm uppercase tracking-wide text-slate-400">Band summary</h3>
            <div class="text-xs muted">
              {% if selected_tactical and selected_tactical.band_summary_meta %}
                {{ selected_tactical.band_summary_meta.band_count or band_summary|length }} bands · {{ '%.1f'|format(selected_tactical.band_summary_meta.band_width_mhz or 0) }} MHz slices
              {% else %}
                Waiting for baseline stats
              {% endif %}
            </div>
          </div>
          {% if band_summary %}
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
              {% for band in band_summary %}
                <div class="border border-white/10 rounded-xl p-4 bg-slate-900/40">
                  <div class="flex items-center justify-between gap-2">
                    <div>
                      <div class="text-sm font-semibold">{{ band.label }}</div>
                      <div class="text-xs text-slate-400">{{ '%.0f'|format((band.occupied_fraction or 0)*100) }}% occupied · {{ band.occupancy_level }}</div>
                    </div>
                    <span class="chip text-xs">{{ band.note }}</span>
                  </div>
                  <div class="flex flex-wrap gap-4 text-xs text-slate-300 mt-3">
                    <span>Persistent {{ band.persistent_signals }}</span>
                    <span>Recent new {{ band.recent_new }}</span>
                    {% if band.avg_noise_db is not none %}<span>Noise {{ '%.1f'|format(band.avg_noise_db) }} dB</span>{% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-sm text-slate-300 border border-dashed border-white/20 rounded-xl p-4">Band-level stats will populate after the baseline captures a few sweeps.</div>
          {% endif %}
        </div>

        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <h3 class="text-sm uppercase tracking-wide text-slate-400">Hotspots</h3>
            <div class="text-xs muted">
              {% if hotspots and hotspots.bucket_width_hz %}
                {{ hotspots.buckets|length }} buckets · {{ '%.3f'|format(hotspots.bucket_width_hz / 1e6) }} MHz each
              {% else %}
                Pending spur/noise stats
              {% endif %}
            </div>
          </div>
          {% if hotspots and hotspots.buckets %}
            {% set max_occ = hotspots.max_occ or 0 %}
            <div class="flex items-end gap-1" aria-label="Hotspot strip">
              {% for bucket in hotspots.buckets %}
                {% set occ = bucket.avg_occ or 0 %}
                {% set height = 48 * (occ / max_occ) if max_occ > 0 else 4 %}
                <div class="flex flex-col items-center gap-1">
                  <div class="w-2 rounded-full bg-sky-500/60" style="height: {{ height|round(0) }}px" title="{{ '%.3f'|format(bucket.f_low_hz/1e6) }}–{{ '%.3f'|format(bucket.f_high_hz/1e6) }} MHz · occ {{ '%.1f'|format(occ*100) }}%"></div>
                </div>
              {% endfor %}
            </div>
            <div class="flex justify-between text-[11px] text-slate-400">
              <span>{{ '%.3f'|format((hotspots.freq_start_hz or 0)/1e6) }} MHz</span>
              <span>{{ '%.3f'|format(((hotspots.freq_start_hz or 0)+(hotspots.freq_stop_hz or 0))/2e6) }} MHz</span>
              <span>{{ '%.3f'|format((hotspots.freq_stop_hz or 0)/1e6) }} MHz</span>
            </div>
          {% else %}
            <div class="text-sm text-slate-300 border border-dashed border-white/20 rounded-xl p-4">Hotspots will appear once spur calibration or baseline noise stats populate.</div>
          {% endif %}
        </div>
      {% else %}
        <div class="text-sm text-slate-300">No baseline selected.</div>
      {% endif %}
    </section>

    <section id="signal-cards" class="card space-y-4">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-xl font-semibold">Signal cards</h2>
          <p class="text-sm text-slate-300">Active detections observed in the past {{ (snapshot.active_window_minutes if snapshot else tactical_config.active_window_minutes) or tactical_config.active_window_minutes }} minutes.</p>
        </div>
        <div class="flex items-center gap-3">
          <a href="/signals?baseline_id={{ selected_baseline_id }}" class="btn text-xs">View all signals</a>
          <span class="text-xs text-slate-400">{{ signal_cards|length }} signals</span>
        </div>
      </div>
      {% if signal_cards %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {% for sig in signal_cards %}
            {% set bw = format_bandwidth_khz(sig.get('bandwidth_hz_display') or sig.get('bandwidth_hz')) %}
            {% set conf = sig.confidence %}
            {% set hits = sig.total_hits or 0 %}
            {% set windows = sig.total_windows or 0 %}
            {% set ratio = hits / windows if windows else 0 %}
            {% set cls = sig.classification or 'unknown' %}
            {% set is_selected = sig.selected %}
            <article class="border rounded-2xl p-4 flex flex-col gap-3 transition-all duration-200 {{ 'border-sky-500/60 bg-sky-900/30 ring-1 ring-sky-500/40' if is_selected else 'border-white/10 bg-slate-900/60' }}" data-signal-id="{{ sig.id }}" data-signal-card>
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <a href="/signal/{{ sig.id }}" class="text-xs font-mono text-sky-400 hover:underline" title="View signal details">{{ sig.signal_id or ('SIG-%04d'|format(sig.id)) }}</a>
                    {% if sig.label %}
                      <span class="chip text-xs bg-amber-600/60 text-amber-100">{{ sig.label }}</span>
                    {% endif %}
                  </div>
                  <div class="text-2xl font-semibold mt-1">{{ format_freq_label(sig.f_center_hz) }}</div>
                </div>
                <div class="flex flex-col items-end gap-2">
                  <button type="button" class="text-lg {{ 'text-sky-400' if is_selected else 'text-slate-500 hover:text-sky-400' }}" data-toggle-select="{{ sig.id }}" title="{{ 'Deselect signal' if is_selected else 'Select signal' }}">
                    {{ '★' if is_selected else '☆' }}
                  </button>
                  {{ classification_chip(cls) }}
                </div>
              </div>
              <div class="flex flex-wrap gap-2">
                {% if sig.near_spur is defined and sig.near_spur %}<span class="chip text-xs bg-amber-700/60">Near spur</span>{% endif %}
                {% if sig.user_bw_hz %}<span class="chip text-xs bg-purple-600/60" title="User-corrected bandwidth">BW adj.</span>{% endif %}
              </div>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <div class="text-xs uppercase tracking-wide muted">Bandwidth</div>
                  <div class="text-lg font-semibold">{{ bw if bw is not none else '—' }}</div>
                </div>
                <div>
                  <div class="text-xs uppercase tracking-wide muted">Confidence</div>
                  <div class="text-lg font-semibold">{% if conf is not none %}{{ (conf * 100)|round(0) }}%{% else %}—{% endif %}</div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <div class="text-xs uppercase tracking-wide muted">First seen</div>
                  <div class="text-lg font-semibold">{{ format_ts_label(sig.first_seen_utc) }}</div>
                </div>
                <div>
                  <div class="text-xs uppercase tracking-wide muted">Last seen</div>
                  <div class="text-lg font-semibold">{{ format_ts_label(sig.last_seen_utc) }}</div>
                </div>
              </div>
              <div class="flex flex-wrap gap-4 text-xs text-slate-300">
                <span>Hits {{ hits }}</span>
                <span>Windows {{ windows }}</span>
                <span>Hit ratio {{ '%.0f'|format(ratio * 100) }}%</span>
              </div>
              {% if sig.notes %}
                <div class="text-xs text-slate-400 italic border-t border-white/10 pt-2 mt-1">{{ sig.notes[:100] }}{% if sig.notes|length > 100 %}...{% endif %}</div>
              {% endif %}
              <div class="flex gap-2 mt-1">
                <a href="/signal/{{ sig.id }}" class="btn text-xs">Details</a>
                <select class="input text-xs py-1" data-classify-signal="{{ sig.id }}" title="Classify signal">
                  <option value="unknown" {{ 'selected' if cls == 'unknown' else '' }}>Unknown</option>
                  <option value="friendly" {{ 'selected' if cls == 'friendly' else '' }}>Friendly</option>
                  <option value="ambient" {{ 'selected' if cls == 'ambient' else '' }}>Ambient</option>
                  <option value="hostile" {{ 'selected' if cls == 'hostile' else '' }}>Hostile</option>
                </select>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-sm text-slate-300">No active signals in the current window. Once sweeps run, persistent detections will land here as cards.</div>
      {% endif %}
    </section>

    <section id="changes-panel" class="card space-y-4">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-xl font-semibold">Current changes / deltas</h2>
          <p class="text-sm text-slate-300">Surface the last {{ change_window_minutes }} minutes of change events.</p>
        </div>
        <div class="flex flex-wrap gap-2" id="change-filter-tabs">
          {% for opt in dashboard_change_filters %}
            {% set params = {'baseline_id': selected_baseline_id} %}
            {% if opt.key != 'ALL' %}
              {% set _ = params.update({'change_filter': opt.key}) %}
            {% endif %}
            <a href="{{ url_for('views.dashboard', **params) }}" class="chip {{ 'chip-active' if dashboard_change_filter == opt.key else '' }}" data-change-filter-link>{{ opt.label }}</a>
          {% endfor %}
        </div>
      </div>
      {% if dashboard_change_payload %}
        <div class="text-xs text-slate-400">
          {{ dashboard_change_payload.total_events }} events · window {{ dashboard_change_payload.window_minutes }} min · refreshed {{ format_ts_label(dashboard_change_payload.generated_at) }}
        </div>
        <div class="space-y-3">
          {% if dashboard_change_payload.events %}
            {% for event in dashboard_change_payload.events %}
              <div class="border border-white/10 rounded-xl p-4 bg-slate-900/40" data-event-type="{{ event.type }}">
                <div class="flex items-center justify-between text-xs text-slate-400">
                  <span class="chip text-xs uppercase tracking-wide {{ 'chip-active' if dashboard_change_filter in ('ALL', event.type) else '' }}">{{ event.type }}</span>
                  <span>{{ event.time_label or format_change_summary(event) }}</span>
                </div>
                <div class="text-sm font-semibold mt-2">{{ format_change_summary(event) }}</div>
                <div class="text-xs text-slate-300 mt-1">{{ event.details }}</div>
                <div class="flex flex-wrap gap-3 text-[11px] text-slate-400 mt-3">
                  {% if event.f_center_hz is not none %}
                    <span>{{ format_freq_label(event.f_center_hz) }}</span>
                  {% endif %}
                  {% set event_bw = format_bandwidth_khz(event.get('bandwidth_hz_display') or event.get('bandwidth_hz')) %}
                  {% if event_bw is not none %}
                    <span>{{ event_bw }}</span>
                  {% endif %}
                  {% if event.confidence is defined and event.confidence is not none %}
                    <span>Confidence {{ '%.2f'|format(event.confidence) }}</span>
                  {% endif %}
                  {% if event.delta_db is defined and event.delta_db is not none %}
                    <span>Δ {{ '%.1f'|format(event.delta_db) }} dB</span>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-sm text-slate-300 border border-dashed border-white/20 rounded-xl p-4">No change events in the selected window.</div>
          {% endif %}
        </div>
      {% else %}
        <div class="text-sm text-slate-300">Select a baseline to view recent changes.</div>
      {% endif %}
    </section>
  {% endif %}
</div>
