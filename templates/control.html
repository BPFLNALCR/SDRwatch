{% extends "base.html" %}
{% set profile_list = profiles or [] %}
{% set has_profiles = profile_list|length > 0 %}
{% set baseline_list = baselines or [] %}
{% set has_baselines = baseline_list|length > 0 %}
{% set baseline_summary_map = baseline_summaries or {} %}
{% block content %}
<section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
  <!-- Main control panel -->
  <div class="card lg:col-span-2">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Spectrum Monitor</h2>
      <div class="flex items-center gap-3">
        <span class="muted text-sm">Status:</span>
        <span id="state-pill" class="pill idle">Idle</span>
      </div>
    </div>

    <!-- Baseline selection -->
    <div class="mb-4 p-4 bg-slate-900/50 rounded-lg border border-slate-700/50">
      <div class="flex items-center justify-between mb-2">
        <label class="font-medium" for="baseline_select">Monitoring Location</label>
        <button type="button" class="text-xs text-cyan-400 hover:text-cyan-300" onclick="showBaselineModal()">+ New location</button>
      </div>
      <select id="baseline_select" class="input w-full" {% if not has_baselines %}disabled{% endif %}>
        <option value="">{% if has_baselines %}Select a location...{% else %}No locations configured{% endif %}</option>
        {% for b in baseline_list %}
        <option value="{{ b.id }}">#{{ b.id }} ¬∑ {{ b.name }}{% if b.antenna %} ({{ b.antenna }}){% endif %}</option>
        {% endfor %}
      </select>
      <div class="text-xs text-slate-400 mt-2" id="baselineInfo">
        {% if has_baselines %}
          Each location represents a unique antenna/site configuration.
        {% else %}
          Create a location to start monitoring.
        {% endif %}
      </div>
    </div>

    <!-- Device selection -->
    <div class="mb-4 p-4 bg-slate-900/50 rounded-lg border border-slate-700/50">
      <label class="font-medium block mb-2">SDR Device</label>
      <div class="flex gap-2">
        <select id="device_key" class="input flex-1"></select>
        <button type="button" class="btn text-sm" id="refreshDevicesBtn" title="Refresh devices">üîÑ</button>
      </div>
      <div class="text-xs text-slate-400 mt-2">Detected RTL-SDR and other compatible devices.</div>
    </div>

    <!-- Monitoring Zones -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-base">Monitoring Zones</h3>
        <div class="flex gap-2">
          <button type="button" class="btn text-xs" onclick="toggleAllZones(true)">Enable All</button>
          <button type="button" class="btn text-xs" onclick="toggleAllZones(false)">Disable All</button>
          <button type="button" class="btn text-xs" onclick="showAddZoneModal()">+ Custom zone</button>
        </div>
      </div>
      <p class="text-sm text-slate-400 mb-3">Select the frequency ranges you want to monitor. Enable zones that are relevant to your location and interests.</p>
      
      <div id="zonesContainer" class="grid gap-2">
        <div class="text-center py-8 text-slate-500">
          <span class="loading">Loading zones...</span>
        </div>
      </div>
    </div>

    <!-- Scan controls -->
    <div class="flex flex-wrap gap-3 mt-6 pt-4 border-t border-slate-700/50">
      <button class="btn btn-primary text-base px-6" type="button" id="startBtn" disabled>
        ‚ñ∂ Start Monitoring
      </button>
      <button class="btn btn-danger text-base px-6" type="button" id="stopBtn">
        ‚ñ† Stop
      </button>
      <div class="flex items-center gap-2 ml-auto">
        <label class="text-sm text-slate-400">Mode:</label>
        <select id="run_mode" class="input text-sm">
          <option value="loop">Continuous</option>
          <option value="single">Single sweep</option>
          <option value="duration">Timed run</option>
        </select>
        <input type="text" id="duration_value" class="input w-20 text-sm hidden" placeholder="e.g. 30m" />
      </div>
    </div>

    <!-- Live logs -->
    <details class="mt-4">
      <summary class="text-sm text-slate-400 cursor-pointer hover:text-slate-300">Show live logs</summary>
      <pre id="log" class="mt-2" style="height:200px;overflow:auto;background:#0b1220;color:#c7f9ff;padding:8px;border-radius:.75rem;font-size:12px"></pre>
    </details>

    <!-- Advanced settings (hidden by default) -->
    <details class="mt-4" id="advancedDetails">
      <summary class="text-sm text-slate-400 cursor-pointer hover:text-slate-300">‚öôÔ∏è Advanced settings</summary>
      <div class="mt-3 p-4 bg-slate-900/30 rounded-lg border border-slate-700/30 space-y-4">
        <p class="text-xs text-slate-500 mb-3">Fine-tune sweep and detection parameters for optimal results. Defaults work well for most RTL-SDR setups.</p>
        
        <form id="advancedForm" class="space-y-4">
          <!-- SDR Settings -->
          <fieldset class="border border-slate-700/50 rounded-lg p-3">
            <legend class="text-sm font-medium text-cyan-400 px-2">SDR Configuration</legend>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div class="field">
                <label for="driver">Driver</label>
                <select id="driver" class="input">
                  <option value="">Auto (SoapySDR)</option>
                  <option value="rtlsdr">RTL-SDR (SoapySDR)</option>
                  <option value="rtlsdr_native">RTL-SDR (Native)</option>
                  <option value="hackrf">HackRF</option>
                  <option value="airspy">Airspy</option>
                  <option value="sdrplay">SDRPlay</option>
                </select>
              </div>
              <div class="field">
                <label for="samp_rate">Sample Rate (Hz)</label>
                <select id="samp_rate" class="input">
                  <option value="2.4e6" selected>2.4 MS/s</option>
                  <option value="2.048e6">2.048 MS/s</option>
                  <option value="1.8e6">1.8 MS/s</option>
                  <option value="3.2e6">3.2 MS/s</option>
                </select>
              </div>
              <div class="field">
                <label for="gain">Gain</label>
                <input id="gain" class="input" value="auto" placeholder="auto or dB value" />
              </div>
              <div class="field">
                <label for="soapy_args">Soapy Args</label>
                <input id="soapy_args" class="input" placeholder="serial=00000001" />
              </div>
            </div>
          </fieldset>

          <!-- FFT & Averaging -->
          <fieldset class="border border-slate-700/50 rounded-lg p-3">
            <legend class="text-sm font-medium text-cyan-400 px-2">FFT & Averaging</legend>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div class="field">
                <label for="fft">FFT Size</label>
                <select id="fft" class="input">
                  <option value="1024">1024</option>
                  <option value="2048">2048</option>
                  <option value="4096" selected>4096</option>
                  <option value="8192">8192</option>
                  <option value="16384">16384</option>
                </select>
              </div>
              <div class="field">
                <label for="avg">Averaging</label>
                <select id="avg" class="input">
                  <option value="1">1 (fast, noisy)</option>
                  <option value="4">4</option>
                  <option value="8" selected>8</option>
                  <option value="16">16</option>
                  <option value="32">32 (slow, clean)</option>
                </select>
              </div>
              <div class="field">
                <label for="step">Step Size (Hz)</label>
                <input id="step" class="input" value="" placeholder="auto (=samp_rate)" />
              </div>
              <div class="field">
                <label for="sleep_between_sweeps">Sleep Between Sweeps (s)</label>
                <input id="sleep_between_sweeps" class="input" type="number" step="0.1" value="0" min="0" />
              </div>
            </div>
          </fieldset>

          <!-- Detection Thresholds -->
          <fieldset class="border border-slate-700/50 rounded-lg p-3">
            <legend class="text-sm font-medium text-cyan-400 px-2">Detection Thresholds</legend>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div class="field">
                <label for="threshold_db">Threshold (dB above noise)</label>
                <input id="threshold_db" class="input" type="number" step="0.5" value="8" />
              </div>
              <div class="field">
                <label for="guard_bins">Guard Bins</label>
                <input id="guard_bins" class="input" type="number" value="1" min="0" title="Allow this many below-threshold bins inside a detection" />
              </div>
              <div class="field">
                <label for="min_width_bins">Min Width Bins</label>
                <input id="min_width_bins" class="input" type="number" value="2" min="1" title="Minimum contiguous bins for a detection" />
              </div>
              <div class="field">
                <label for="cluster_merge_hz">Cluster Merge (Hz)</label>
                <input id="cluster_merge_hz" class="input" type="number" value="" placeholder="auto" title="Hz span when merging segments into clusters" />
              </div>
              <div class="field">
                <label for="max_detection_width_hz">Max Detection Width (Hz)</label>
                <input id="max_detection_width_hz" class="input" type="number" value="" placeholder="unlimited" title="Clamp persistent detection widths" />
              </div>
              <div class="field">
                <label for="max_detection_width_ratio">Max Width Ratio</label>
                <input id="max_detection_width_ratio" class="input" type="number" step="0.1" value="3.0" title="Reject clusters exceeding this ratio of persisted width" />
              </div>
              <div class="field">
                <label for="new_ema_occ">New EMA Threshold</label>
                <input id="new_ema_occ" class="input" type="number" step="0.01" value="0.02" title="EMA occupancy threshold to flag bin as NEW" />
              </div>
            </div>
          </fieldset>

          <!-- CFAR Settings -->
          <fieldset class="border border-slate-700/50 rounded-lg p-3">
            <legend class="text-sm font-medium text-cyan-400 px-2">CFAR (Constant False Alarm Rate)</legend>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
              <div class="field">
                <label for="cfar">CFAR Mode</label>
                <select id="cfar" class="input">
                  <option value="">Default (OS)</option>
                  <option value="os">OS-CFAR</option>
                  <option value="ca">CA-CFAR</option>
                  <option value="off">Off</option>
                </select>
              </div>
              <div class="field">
                <label for="cfar_train">Training Cells</label>
                <input id="cfar_train" class="input" type="number" value="24" min="1" title="Training cells per side" />
              </div>
              <div class="field">
                <label for="cfar_guard">Guard Cells</label>
                <input id="cfar_guard" class="input" type="number" value="4" min="0" title="Guard cells excluded around CUT" />
              </div>
              <div class="field">
                <label for="cfar_quantile">Quantile (OS)</label>
                <input id="cfar_quantile" class="input" type="number" step="0.05" value="0.75" min="0" max="1" title="Quantile for OS-CFAR" />
              </div>
              <div class="field">
                <label for="cfar_alpha_db">Alpha (dB)</label>
                <input id="cfar_alpha_db" class="input" type="number" step="0.5" value="" placeholder="=threshold" title="Override threshold scaling" />
              </div>
            </div>
          </fieldset>

          <!-- Persistence Settings -->
          <fieldset class="border border-slate-700/50 rounded-lg p-3">
            <legend class="text-sm font-medium text-cyan-400 px-2">Persistence</legend>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
              <div class="field">
                <label for="persistence_mode">Mode</label>
                <select id="persistence_mode" class="input">
                  <option value="">Default (hits)</option>
                  <option value="hits">Hits</option>
                  <option value="duration">Duration</option>
                  <option value="both">Both</option>
                </select>
              </div>
              <div class="field">
                <label for="persistence_hit_ratio">Hit Ratio</label>
                <input id="persistence_hit_ratio" class="input" type="number" step="0.05" value="0.6" min="0" max="1" title="Min window ratio for persistence" />
              </div>
              <div class="field">
                <label for="persistence_min_seconds">Min Seconds</label>
                <input id="persistence_min_seconds" class="input" type="number" step="1" value="10" min="0" title="Min duration for duration-based persistence" />
              </div>
              <div class="field">
                <label for="persistence_min_hits">Min Hits</label>
                <input id="persistence_min_hits" class="input" type="number" value="2" min="1" title="Min hits before persistence eval" />
              </div>
              <div class="field">
                <label for="persistence_min_windows">Min Windows</label>
                <input id="persistence_min_windows" class="input" type="number" value="2" min="1" title="Min windows before persistence eval" />
              </div>
            </div>
          </fieldset>

          <!-- Two-Pass / Revisit Settings -->
          <fieldset class="border border-slate-700/50 rounded-lg p-3">
            <legend class="text-sm font-medium text-cyan-400 px-2">Two-Pass Verification</legend>
            <div class="grid grid-cols-2 md:grid-cols-6 gap-3 text-sm">
              <div class="field col-span-2 md:col-span-1">
                <label class="flex items-center gap-2 mt-5">
                  <input type="checkbox" id="two_pass" />
                  <span>Enable</span>
                </label>
              </div>
              <div class="field">
                <label for="revisit_fft">Revisit FFT</label>
                <input id="revisit_fft" class="input" type="number" value="" placeholder="2x main" title="FFT size for revisit windows" />
              </div>
              <div class="field">
                <label for="revisit_avg">Revisit Avg</label>
                <input id="revisit_avg" class="input" type="number" value="" placeholder="auto" title="Averaging for revisit windows" />
              </div>
              <div class="field">
                <label for="revisit_margin_hz">Margin (Hz)</label>
                <input id="revisit_margin_hz" class="input" type="number" value="" placeholder="auto" title="Additional Hz margin around revisit center" />
              </div>
              <div class="field">
                <label for="revisit_span_limit_hz">Span Limit (Hz)</label>
                <input id="revisit_span_limit_hz" class="input" type="number" value="" placeholder="none" title="Max Hz span for revisit confirmation" />
              </div>
              <div class="field">
                <label for="revisit_max_bands">Max Bands</label>
                <input id="revisit_max_bands" class="input" type="number" value="" placeholder="unlimited" title="Max revisit targets per sweep" />
              </div>
              <div class="field">
                <label for="revisit_floor_threshold_db">Floor Threshold (dB)</label>
                <input id="revisit_floor_threshold_db" class="input" type="number" step="0.5" value="" placeholder="=threshold" title="Detection threshold for revisit windows" />
              </div>
            </div>
          </fieldset>

          <!-- Profile & Bandplan -->
          <fieldset class="border border-slate-700/50 rounded-lg p-3">
            <legend class="text-sm font-medium text-cyan-400 px-2">Profile & Bandplan</legend>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
              <div class="field">
                <label for="profile">Scan Profile</label>
                <select id="profile" class="input">
                  <option value="">(none - use zone settings)</option>
                  {% for prof in profile_list %}
                  <option value="{{ prof.name }}">{{ prof.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="field">
                <label for="bandplan">Bandplan</label>
                <select id="bandplan" class="input">
                  <option value="">None</option>
                  <!-- Populated dynamically -->
                </select>
              </div>
              <div class="field">
                <label for="db">Database Path</label>
                <input id="db" class="input" value="{{ db_path }}" />
              </div>
            </div>
          </fieldset>

          <!-- Other Options -->
          <fieldset class="border border-slate-700/50 rounded-lg p-3">
            <legend class="text-sm font-medium text-cyan-400 px-2">Other Options</legend>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div class="field">
                <label for="latitude">Latitude</label>
                <input id="latitude" class="input" type="number" step="0.0001" placeholder="41.8781" />
              </div>
              <div class="field">
                <label for="longitude">Longitude</label>
                <input id="longitude" class="input" type="number" step="0.0001" placeholder="-87.6298" />
              </div>
              <div class="field">
                <label for="jsonl">JSONL Output</label>
                <input id="jsonl" class="input" placeholder="detections.jsonl" />
              </div>
              <div class="field">
                <label class="flex items-center gap-2 mt-5">
                  <input type="checkbox" id="spur_calibration" />
                  <span>Spur Calibration Mode</span>
                </label>
              </div>
            </div>
          </fieldset>
        </form>
      </div>
    </details>
  </div>

  <!-- Sidebar -->
  <div class="space-y-4">
    <!-- Friendly signals -->
    <div class="card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Known Signals</h3>
        <button type="button" class="btn text-xs" onclick="showAddFriendlyModal()">+ Add</button>
      </div>
      <p class="text-xs text-slate-400 mb-3">Mark signals you recognize as friendly. These won't trigger alerts.</p>
      <div id="friendlyContainer" class="space-y-2 max-h-64 overflow-y-auto">
        <div class="text-center py-4 text-slate-500 text-sm">
          Select a location to view known signals.
        </div>
      </div>
    </div>

    <!-- Quick actions -->
    <div class="card">
      <h3 class="font-semibold mb-3">Quick Start</h3>
      <div class="space-y-2">
        <button class="btn w-full text-left justify-start" onclick="enableZonesByCategory('broadcast')">
          üìª Monitor Broadcasts
          <span class="text-xs text-slate-400 ml-auto">FM, AM stations</span>
        </button>
        <button class="btn w-full text-left justify-start" onclick="enableZonesByCategory('aviation')">
          ‚úàÔ∏è Monitor Aviation
          <span class="text-xs text-slate-400 ml-auto">Airband, ADS-B</span>
        </button>
        <button class="btn w-full text-left justify-start" onclick="enableZonesByCategory('public_safety')">
          üöî Monitor Public Safety
          <span class="text-xs text-slate-400 ml-auto">Police, Fire, EMS</span>
        </button>
        <button class="btn w-full text-left justify-start" onclick="enableZonesByCategory('amateur')">
          üì° Monitor Ham Radio
          <span class="text-xs text-slate-400 ml-auto">2m, 70cm bands</span>
        </button>
        <button class="btn w-full text-left justify-start" onclick="enableZonesByCategory('ism')">
          üì∂ Monitor IoT/ISM
          <span class="text-xs text-slate-400 ml-auto">LoRa, smart devices</span>
        </button>
      </div>
    </div>

    <!-- Create baseline modal content (hidden) -->
    <div id="baselineModal" class="card hidden">
      <h3 class="font-semibold mb-3">New Monitoring Location</h3>
      <form id="baselineForm" class="space-y-3">
        <div class="field"><label>Name</label><input id="baseline_name" class="input" name="name" placeholder="e.g. Roof antenna" required /></div>
        <div class="grid grid-cols-2 gap-2">
          <div class="field"><label>Latitude</label><input id="baseline_lat" class="input" name="location_lat" placeholder="41.878" /></div>
          <div class="field"><label>Longitude</label><input id="baseline_lon" class="input" name="location_lon" placeholder="-87.629" /></div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div class="field"><label>SDR Serial</label><input id="baseline_serial" class="input" name="sdr_serial" placeholder="rtl0001" /></div>
          <div class="field"><label>Antenna</label><input id="baseline_antenna" class="input" name="antenna" placeholder="Discone" /></div>
        </div>
        <div class="field"><label>Notes</label><textarea id="baseline_notes" class="input" name="notes" rows="2" placeholder="Description of this monitoring setup"></textarea></div>
        <div class="flex gap-2">
          <button type="submit" class="btn btn-primary">Create</button>
          <button type="button" class="btn" onclick="hideBaselineModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- Add Zone Modal -->
<div id="addZoneModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50" onclick="if(event.target===this)hideAddZoneModal()">
  <div class="card max-w-md w-full mx-4" onclick="event.stopPropagation()">
    <h3 class="font-semibold mb-4">Add Custom Monitoring Zone</h3>
    <form id="addZoneForm" class="space-y-3">
      <div class="field"><label>Zone Name</label><input id="zone_name" class="input" required placeholder="My custom zone" /></div>
      <div class="field"><label>Description</label><input id="zone_desc" class="input" placeholder="What this zone covers" /></div>
      <div class="grid grid-cols-2 gap-3">
        <div class="field"><label>Start Frequency (MHz)</label><input id="zone_start" class="input" type="number" step="0.001" required placeholder="88.0" /></div>
        <div class="field"><label>Stop Frequency (MHz)</label><input id="zone_stop" class="input" type="number" step="0.001" required placeholder="108.0" /></div>
      </div>
      <div class="field">
        <label>Category</label>
        <select id="zone_category" class="input">
          <option value="custom">Custom</option>
          <option value="surveillance">Surveillance</option>
          <option value="broadcast">Broadcast</option>
          <option value="aviation">Aviation</option>
          <option value="amateur">Amateur Radio</option>
          <option value="marine">Marine</option>
          <option value="public_safety">Public Safety</option>
          <option value="consumer">Consumer</option>
          <option value="ism">ISM/IoT</option>
        </select>
      </div>
      <div class="flex gap-2 mt-4">
        <button type="submit" class="btn btn-primary">Add Zone</button>
        <button type="button" class="btn" onclick="hideAddZoneModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Friendly Signal Modal -->
<div id="addFriendlyModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50" onclick="if(event.target===this)hideAddFriendlyModal()">
  <div class="card max-w-md w-full mx-4" onclick="event.stopPropagation()">
    <h3 class="font-semibold mb-4">Add Known Signal</h3>
    <form id="addFriendlyForm" class="space-y-3">
      <div class="field"><label>Label</label><input id="friendly_label" class="input" required placeholder="Local FM station" /></div>
      <div class="grid grid-cols-2 gap-3">
        <div class="field"><label>Center Frequency (MHz)</label><input id="friendly_freq" class="input" type="number" step="0.001" required placeholder="101.5" /></div>
        <div class="field"><label>Tolerance (kHz)</label><input id="friendly_tolerance" class="input" type="number" value="10" placeholder="10" /></div>
      </div>
      <div class="field"><label>Notes</label><textarea id="friendly_notes" class="input" rows="2" placeholder="Why this signal is known/expected"></textarea></div>
      <div class="flex gap-2 mt-4">
        <button type="submit" class="btn btn-primary">Add Signal</button>
        <button type="button" class="btn" onclick="hideAddFriendlyModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const TOKEN = localStorage.getItem("SDRWATCH_TOKEN") || "";
function authHeaders(isJson=true){
  const headers = {};
  if (TOKEN) headers["Authorization"] = "Bearer "+TOKEN;
  if (isJson) headers["Content-Type"] = "application/json";
  return headers;
}

// State
let activeBaselineId = null;
let zones = [];
let friendlySignals = [];
let activeJob = null;
let lastJobId = null;
const BASELINE_STORAGE_KEY = 'SDRWATCH_ACTIVE_BASELINE_ID';

// Category display info
const CATEGORY_INFO = {
  surveillance: { icon: 'üîç', color: 'slate' },
  broadcast: { icon: 'üìª', color: 'purple' },
  aviation: { icon: '‚úàÔ∏è', color: 'sky' },
  amateur: { icon: 'üì°', color: 'amber' },
  marine: { icon: 'üö¢', color: 'blue' },
  weather: { icon: 'üå§Ô∏è', color: 'teal' },
  public_safety: { icon: 'üöî', color: 'red' },
  consumer: { icon: 'üì±', color: 'green' },
  ism: { icon: 'üì∂', color: 'violet' },
  cellular: { icon: 'üì∂', color: 'orange' },
  paging: { icon: 'üìü', color: 'pink' },
  custom: { icon: '‚öôÔ∏è', color: 'gray' }
};

// Elements
const pill = document.getElementById('state-pill');
const baselineSelect = document.getElementById('baseline_select');
const zonesContainer = document.getElementById('zonesContainer');
const friendlyContainer = document.getElementById('friendlyContainer');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const runModeSelect = document.getElementById('run_mode');
const durationInput = document.getElementById('duration_value');
const log = document.getElementById('log');

// Utility functions
function setState(s){ 
  pill.textContent = s; 
  pill.className = 'pill ' + (s==='running'?'run':'idle'); 
}

function formatFreq(hz) {
  const mhz = hz / 1e6;
  if (mhz >= 1000) return (mhz / 1000).toFixed(2) + ' GHz';
  if (mhz >= 1) return mhz.toFixed(3) + ' MHz';
  return (hz / 1000).toFixed(1) + ' kHz';
}

// Modal functions
function showBaselineModal() {
  document.getElementById('baselineModal').classList.remove('hidden');
}
function hideBaselineModal() {
  document.getElementById('baselineModal').classList.add('hidden');
}
function showAddZoneModal() {
  if (!activeBaselineId) { alert('Select a location first'); return; }
  document.getElementById('addZoneModal').classList.remove('hidden');
  document.getElementById('addZoneModal').classList.add('flex');
}
function hideAddZoneModal() {
  document.getElementById('addZoneModal').classList.add('hidden');
  document.getElementById('addZoneModal').classList.remove('flex');
  document.getElementById('addZoneForm').reset();
}
function showAddFriendlyModal() {
  if (!activeBaselineId) { alert('Select a location first'); return; }
  document.getElementById('addFriendlyModal').classList.remove('hidden');
  document.getElementById('addFriendlyModal').classList.add('flex');
}
function hideAddFriendlyModal() {
  document.getElementById('addFriendlyModal').classList.add('hidden');
  document.getElementById('addFriendlyModal').classList.remove('flex');
  document.getElementById('addFriendlyForm').reset();
}

// Zones rendering
function renderZones() {
  if (!zones.length) {
    zonesContainer.innerHTML = '<div class="text-center py-6 text-slate-500">No monitoring zones configured for this location.</div>';
    return;
  }

  // Group by category
  const byCategory = {};
  zones.forEach(z => {
    const cat = z.category || 'custom';
    if (!byCategory[cat]) byCategory[cat] = [];
    byCategory[cat].push(z);
  });

  let html = '';
  for (const [cat, catZones] of Object.entries(byCategory)) {
    const info = CATEGORY_INFO[cat] || CATEGORY_INFO.custom;
    html += `<div class="mb-3">
      <div class="text-xs font-medium text-slate-400 mb-1 flex items-center gap-1">
        <span>${info.icon}</span>
        <span>${cat.replace('_', ' ').toUpperCase()}</span>
      </div>
      <div class="space-y-1">`;
    
    catZones.forEach(z => {
      const freqRange = `${formatFreq(z.f_start_hz)} ‚Äì ${formatFreq(z.f_stop_hz)}`;
      html += `
        <label class="flex items-center gap-3 p-2 rounded-lg bg-slate-800/50 hover:bg-slate-800 cursor-pointer transition-colors ${z.enabled ? 'border border-cyan-500/40' : 'border border-transparent'}">
          <input type="checkbox" class="zone-checkbox" data-zone-id="${z.id}" ${z.enabled ? 'checked' : ''} onchange="toggleZone(${z.id}, this.checked)" />
          <div class="flex-1 min-w-0">
            <div class="font-medium text-sm truncate">${z.name}</div>
            <div class="text-xs text-slate-400">${freqRange}</div>
          </div>
          ${z.is_preset ? '' : `<button type="button" class="text-red-400 hover:text-red-300 text-xs" onclick="event.preventDefault();deleteZone(${z.id})">‚úï</button>`}
        </label>`;
    });
    html += '</div></div>';
  }
  zonesContainer.innerHTML = html;
  updateStartButton();
}

function renderFriendly() {
  if (!friendlySignals.length) {
    friendlyContainer.innerHTML = '<div class="text-center py-4 text-slate-500 text-sm">No known signals configured.</div>';
    return;
  }

  let html = '';
  friendlySignals.forEach(s => {
    html += `
      <div class="flex items-center gap-2 p-2 rounded-lg bg-slate-800/50 text-sm">
        <span class="text-green-400">‚úì</span>
        <div class="flex-1 min-w-0">
          <div class="font-medium truncate">${s.label}</div>
          <div class="text-xs text-slate-400">${formatFreq(s.f_center_hz)} ¬±${(s.f_tolerance_hz/1000).toFixed(1)}kHz</div>
        </div>
        <button type="button" class="text-red-400 hover:text-red-300 text-xs" onclick="deleteFriendly(${s.id})">‚úï</button>
      </div>`;
  });
  friendlyContainer.innerHTML = html;
}

function updateStartButton() {
  const enabledZones = zones.filter(z => z.enabled);
  startBtn.disabled = !activeBaselineId || enabledZones.length === 0;
  if (!activeBaselineId) {
    startBtn.title = 'Select a location first';
  } else if (enabledZones.length === 0) {
    startBtn.title = 'Enable at least one monitoring zone';
  } else {
    startBtn.title = `Monitor ${enabledZones.length} zone(s)`;
  }
}

// API calls
async function loadZones() {
  if (!activeBaselineId) {
    zones = [];
    renderZones();
    return;
  }
  try {
    const resp = await fetch(`/api/baseline/${activeBaselineId}/zones`, { headers: authHeaders(false) });
    if (!resp.ok) throw new Error('Failed to load zones');
    const data = await resp.json();
    zones = data.zones || [];
    renderZones();
  } catch (err) {
    console.error(err);
    zonesContainer.innerHTML = '<div class="text-red-400 text-sm">Failed to load zones</div>';
  }
}

async function loadFriendly() {
  if (!activeBaselineId) {
    friendlySignals = [];
    renderFriendly();
    return;
  }
  try {
    const resp = await fetch(`/api/baseline/${activeBaselineId}/friendly`, { headers: authHeaders(false) });
    if (!resp.ok) throw new Error('Failed to load friendly signals');
    const data = await resp.json();
    friendlySignals = data.friendly_signals || [];
    renderFriendly();
  } catch (err) {
    console.error(err);
    friendlyContainer.innerHTML = '<div class="text-red-400 text-sm">Failed to load</div>';
  }
}

async function toggleZone(zoneId, enabled) {
  try {
    await fetch(`/api/zones/${zoneId}`, {
      method: 'PATCH',
      headers: authHeaders(),
      body: JSON.stringify({ enabled })
    });
    const z = zones.find(z => z.id === zoneId);
    if (z) z.enabled = enabled;
    renderZones();
  } catch (err) {
    console.error(err);
    loadZones(); // Reload on error
  }
}

async function toggleAllZones(enabled) {
  if (!activeBaselineId) return;
  const zoneIds = zones.map(z => z.id);
  try {
    await fetch(`/api/baseline/${activeBaselineId}/zones/bulk-enable`, {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify({ zone_ids: zoneIds, enabled })
    });
    await loadZones();
  } catch (err) {
    console.error(err);
  }
}

async function enableZonesByCategory(category) {
  if (!activeBaselineId) { alert('Select a location first'); return; }
  // First disable all, then enable matching category
  const allIds = zones.map(z => z.id);
  const catIds = zones.filter(z => z.category === category).map(z => z.id);
  
  if (catIds.length === 0) {
    alert(`No ${category} zones available`);
    return;
  }

  try {
    // Disable all
    await fetch(`/api/baseline/${activeBaselineId}/zones/bulk-enable`, {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify({ zone_ids: allIds, enabled: false })
    });
    // Enable category
    await fetch(`/api/baseline/${activeBaselineId}/zones/bulk-enable`, {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify({ zone_ids: catIds, enabled: true })
    });
    await loadZones();
  } catch (err) {
    console.error(err);
  }
}

async function deleteZone(zoneId) {
  if (!confirm('Delete this custom zone?')) return;
  try {
    await fetch(`/api/zones/${zoneId}`, { method: 'DELETE', headers: authHeaders() });
    await loadZones();
  } catch (err) {
    console.error(err);
  }
}

async function deleteFriendly(signalId) {
  if (!confirm('Remove this known signal?')) return;
  try {
    await fetch(`/api/friendly/${signalId}`, { method: 'DELETE', headers: authHeaders() });
    await loadFriendly();
  } catch (err) {
    console.error(err);
  }
}

// Baseline selection
function onBaselineChange() {
  const val = baselineSelect.value;
  activeBaselineId = val ? parseInt(val, 10) : null;
  if (activeBaselineId) {
    localStorage.setItem(BASELINE_STORAGE_KEY, String(activeBaselineId));
  } else {
    localStorage.removeItem(BASELINE_STORAGE_KEY);
  }
  loadZones();
  loadFriendly();
  updateStartButton();
}
baselineSelect.addEventListener('change', onBaselineChange);

// Run mode toggle
runModeSelect.addEventListener('change', () => {
  durationInput.classList.toggle('hidden', runModeSelect.value !== 'duration');
});

// Forms
document.getElementById('baselineForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    name: form.name.value,
    location_lat: form.location_lat.value || null,
    location_lon: form.location_lon.value || null,
    sdr_serial: form.sdr_serial.value || null,
    antenna: form.antenna.value || null,
    notes: form.notes.value || null, 
  };
  try {
    const resp = await fetch('/api/baselines', {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data?.error || 'Failed');
    // Reload page to get new baseline in list
    location.reload();
  } catch (err) {
    alert('Failed to create location: ' + err.message);
  }
});

document.getElementById('addZoneForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    name: document.getElementById('zone_name').value,
    description: document.getElementById('zone_desc').value,
    f_start_hz: Math.round(parseFloat(document.getElementById('zone_start').value) * 1e6),
    f_stop_hz: Math.round(parseFloat(document.getElementById('zone_stop').value) * 1e6),
    category: document.getElementById('zone_category').value,
    enabled: true
  };
  try {
    const resp = await fetch(`/api/baseline/${activeBaselineId}/zones`, {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });
    if (!resp.ok) throw new Error('Failed');
    hideAddZoneModal();
    await loadZones();
  } catch (err) {
    alert('Failed to add zone: ' + err.message);
  }
});

document.getElementById('addFriendlyForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = {
    label: document.getElementById('friendly_label').value,
    f_center_hz: Math.round(parseFloat(document.getElementById('friendly_freq').value) * 1e6),
    f_tolerance_hz: Math.round(parseFloat(document.getElementById('friendly_tolerance').value || 10) * 1000),
    notes: document.getElementById('friendly_notes').value
  };
  try {
    const resp = await fetch(`/api/baseline/${activeBaselineId}/friendly`, {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });
    if (!resp.ok) throw new Error('Failed');
    hideAddFriendlyModal();
    await loadFriendly();
  } catch (err) {
    alert('Failed to add signal: ' + err.message);
  }
});

// Device enumeration
async function loadDevices(){
  try{
    const r = await fetch('/ctl/devices');
    const data = await r.json();
    const sel = document.getElementById('device_key');
    sel.innerHTML = '';
    if (!Array.isArray(data)) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = `(${data?.error || 'controller error'})`;
      sel.appendChild(opt);
      return;
    }
    if (data.length === 0){
      const opt = document.createElement('option'); 
      opt.value = ''; 
      opt.textContent = '(no devices found)'; 
      sel.appendChild(opt);
    } else {
      for(const d of data){
        const opt = document.createElement('option');
        opt.value = d.key; 
        opt.textContent = d.label + ' [' + d.kind + ']';
        sel.appendChild(opt);
      }
    }
  }catch(e){ console.error(e); }
}
loadDevices();
document.getElementById('refreshDevicesBtn')?.addEventListener('click', loadDevices);

// Bandplan enumeration
async function loadBandplans(){
  try {
    const r = await fetch('/api/bandplans', { headers: authHeaders(false) });
    if (!r.ok) return;
    const data = await r.json();
    const sel = document.getElementById('bandplan');
    if (!sel) return;
    // Keep the first "None" option
    while (sel.options.length > 1) sel.remove(1);
    for (const bp of (data.bandplans || [])) {
      const opt = document.createElement('option');
      opt.value = bp.path;
      opt.textContent = bp.display_name + ' (' + bp.filename + ')';
      sel.appendChild(opt);
    }
  } catch(e) { console.error('Failed to load bandplans:', e); }
}
loadBandplans();

// Start/Stop scan
startBtn.addEventListener('click', async () => {
  if (!activeBaselineId) { alert('Select a location first'); return; }
  
  const enabledZones = zones.filter(z => z.enabled);
  if (enabledZones.length === 0) { alert('Enable at least one monitoring zone'); return; }

  // Calculate combined frequency range from enabled zones
  const startHz = Math.min(...enabledZones.map(z => z.f_start_hz));
  const stopHz = Math.max(...enabledZones.map(z => z.f_stop_hz));

  // Helper to get input value or undefined
  const getVal = (id, parser = parseFloat) => {
    const el = document.getElementById(id);
    if (!el) return undefined;
    const v = el.value?.trim();
    if (v === '' || v === null || v === undefined) return undefined;
    if (parser === String) return v;
    const parsed = parser(v);
    return isNaN(parsed) ? undefined : parsed;
  };
  const getCheck = (id) => document.getElementById(id)?.checked || false;
  const getSelect = (id) => {
    const el = document.getElementById(id);
    return el?.value?.trim() || undefined;
  };

  // Build params object with all advanced settings
  const params = {
    start: startHz,
    stop: stopHz,
  };

  // SDR Configuration
  const driver = getSelect('driver');
  if (driver) params.driver = driver;
  
  const sampRate = getVal('samp_rate');
  if (sampRate) {
    params.samp_rate = sampRate;
    params.step = getVal('step') || sampRate; // step defaults to samp_rate
  }
  
  const gain = getSelect('gain') || getVal('gain', String);
  if (gain) params.gain = gain;
  
  const soapyArgs = getVal('soapy_args', String);
  if (soapyArgs) params.soapy_args = soapyArgs;

  // FFT & Averaging
  const fft = getVal('fft', parseInt);
  if (fft) params.fft = fft;
  
  const avg = getVal('avg', parseInt);
  if (avg) params.avg = avg;
  
  const sleepBetweenSweeps = getVal('sleep_between_sweeps');
  if (sleepBetweenSweeps !== undefined) params.sleep_between_sweeps = sleepBetweenSweeps;

  // Detection Thresholds
  const thresholdDb = getVal('threshold_db');
  if (thresholdDb !== undefined) params.threshold_db = thresholdDb;
  
  const guardBins = getVal('guard_bins', parseInt);
  if (guardBins !== undefined) params.guard_bins = guardBins;
  
  const minWidthBins = getVal('min_width_bins', parseInt);
  if (minWidthBins !== undefined) params.min_width_bins = minWidthBins;
  
  const clusterMergeHz = getVal('cluster_merge_hz');
  if (clusterMergeHz) params.cluster_merge_hz = clusterMergeHz;
  
  const maxDetectionWidthHz = getVal('max_detection_width_hz');
  if (maxDetectionWidthHz) params.max_detection_width_hz = maxDetectionWidthHz;
  
  const maxDetectionWidthRatio = getVal('max_detection_width_ratio');
  if (maxDetectionWidthRatio) params.max_detection_width_ratio = maxDetectionWidthRatio;
  
  const newEmaOcc = getVal('new_ema_occ');
  if (newEmaOcc) params.new_ema_occ = newEmaOcc;

  // CFAR Settings
  const cfar = getSelect('cfar');
  if (cfar) params.cfar = cfar;
  
  const cfarTrain = getVal('cfar_train', parseInt);
  if (cfarTrain !== undefined) params.cfar_train = cfarTrain;
  
  const cfarGuard = getVal('cfar_guard', parseInt);
  if (cfarGuard !== undefined) params.cfar_guard = cfarGuard;
  
  const cfarQuantile = getVal('cfar_quantile');
  if (cfarQuantile !== undefined) params.cfar_quantile = cfarQuantile;
  
  const cfarAlphaDb = getVal('cfar_alpha_db');
  if (cfarAlphaDb !== undefined) params.cfar_alpha_db = cfarAlphaDb;

  // Persistence Settings
  const persistenceMode = getSelect('persistence_mode');
  if (persistenceMode) params.persistence_mode = persistenceMode;
  
  const persistenceHitRatio = getVal('persistence_hit_ratio');
  if (persistenceHitRatio !== undefined) params.persistence_hit_ratio = persistenceHitRatio;
  
  const persistenceMinSeconds = getVal('persistence_min_seconds');
  if (persistenceMinSeconds !== undefined) params.persistence_min_seconds = persistenceMinSeconds;
  
  const persistenceMinHits = getVal('persistence_min_hits', parseInt);
  if (persistenceMinHits !== undefined) params.persistence_min_hits = persistenceMinHits;
  
  const persistenceMinWindows = getVal('persistence_min_windows', parseInt);
  if (persistenceMinWindows !== undefined) params.persistence_min_windows = persistenceMinWindows;

  // Two-Pass / Revisit Settings
  if (getCheck('two_pass')) {
    params.two_pass = true;
    
    const revisitFft = getVal('revisit_fft', parseInt);
    if (revisitFft) params.revisit_fft = revisitFft;
    
    const revisitAvg = getVal('revisit_avg', parseInt);
    if (revisitAvg) params.revisit_avg = revisitAvg;
    
    const revisitMarginHz = getVal('revisit_margin_hz');
    if (revisitMarginHz) params.revisit_margin_hz = revisitMarginHz;
    
    const revisitSpanLimitHz = getVal('revisit_span_limit_hz');
    if (revisitSpanLimitHz) params.revisit_span_limit_hz = revisitSpanLimitHz;
    
    const revisitMaxBands = getVal('revisit_max_bands', parseInt);
    if (revisitMaxBands) params.revisit_max_bands = revisitMaxBands;
    
    const revisitFloorThresholdDb = getVal('revisit_floor_threshold_db');
    if (revisitFloorThresholdDb) params.revisit_floor_threshold_db = revisitFloorThresholdDb;
  }

  // Profile & Bandplan
  const profile = getSelect('profile');
  if (profile) params.profile = profile;

  const bandplan = getSelect('bandplan');
  if (bandplan) params.bandplan = bandplan;

  const db = getVal('db', String);
  if (db) params.db = db;

  // Other Options
  const latitude = getVal('latitude');
  if (latitude !== undefined) params.latitude = latitude;
  
  const longitude = getVal('longitude');
  if (longitude !== undefined) params.longitude = longitude;
  
  const jsonl = getVal('jsonl', String);
  if (jsonl) params.jsonl = jsonl;
  
  if (getCheck('spur_calibration')) {
    params.spur_calibration = true;
  }

  // Run mode
  const mode = runModeSelect.value;
  if (mode === 'loop') params.loop = true;
  if (mode === 'duration') params.duration = durationInput.value || '30m';

  const device_key = document.getElementById('device_key').value;
  const payload = {
    device_key,
    label: 'web',
    baseline_id: activeBaselineId,
    params
  };

  try {
    const r = await fetch('/api/jobs', {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data?.error || 'start failed');
    if (data.job) {
      activeJob = data.job;
      lastJobId = data.job.id;
    }
    setState('running');
  } catch (err) {
    alert('Failed to start: ' + err.message);
  }
});

stopBtn.addEventListener('click', async () => {
  if (!activeJob?.id) {
    await refreshActiveState();
  }
  if (!activeJob?.id) {
    setState('idle');
    return;
  }
  try {
    await fetch(`/api/jobs/${encodeURIComponent(activeJob.id)}`, {
      method: 'DELETE',
      headers: authHeaders()
    });
    activeJob = null;
    setState('idle');
  } catch (err) {
    console.error(err);
  }
});

// Polling
async function refreshActiveState(){
  try{
    const r = await fetch('/api/jobs/active', { headers: authHeaders(false) });
    if(!r.ok) return;
    const data = await r.json();
    if(data?.job){
      activeJob = data.job;
      if(activeJob?.id) lastJobId = activeJob.id;
      setState(data.state || 'running');
    } else {
      activeJob = null;
      setState(data?.state || 'idle');
    }
  }catch(err){ console.error(err); }
}

async function poll(){
  await refreshActiveState();
  setTimeout(poll, 2000);
}
poll();

// Logs
let userScrolling = false;
log?.addEventListener('scroll', () => {
  const nearBottom = (log.scrollHeight - log.scrollTop - log.clientHeight) < 24;
  userScrolling = !nearBottom;
});

async function pollLogs(){
  const jobId = activeJob?.id || lastJobId;
  if(!jobId){
    setTimeout(pollLogs, 2000);
    return;
  }
  try{
    const r = await fetch(`/api/jobs/${encodeURIComponent(jobId)}/logs?tail=200`, { headers: authHeaders(false) });
    if(r.ok){
      const t = await r.text();
      if(t) log.textContent = t;
      if(!userScrolling) log.scrollTop = log.scrollHeight;
    }
  }catch(e){}
  setTimeout(pollLogs, 2000);
}
pollLogs();

// Initialize
const savedBaseline = localStorage.getItem(BASELINE_STORAGE_KEY);
if (savedBaseline) {
  baselineSelect.value = savedBaseline;
}
onBaselineChange();
</script>
{% endblock %}
