{% extends "base.html" %}
{% set profile_list = profiles or [] %}
{% set has_profiles = profile_list|length > 0 %}
{% set baseline_list = baselines or [] %}
{% set has_baselines = baseline_list|length > 0 %}
{% set baseline_summary_map = baseline_summaries or {} %}
{% block content %}
<section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
  <div class="card lg:col-span-2">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">SDRwatch Control</h2>
      <div><span class="muted">State:</span> <span id="state-pill" class="pill idle">Idle</span></div>
    </div>

    <form id="ctl" class="grid gap-4">
      <div>
        <div class="section-title">Baseline</div>
        <div class="subgrid">
          <div class="field">
            <label for="baseline_select">Active baseline</label>
            <select id="baseline_select" class="input" {% if not has_baselines %}disabled{% endif %}>
              <option value="">{% if has_baselines %}(select baseline){% else %}(no baselines yet){% endif %}</option>
              {% for b in baseline_list %}
              {% set start_mhz = (b.freq_start_hz or 0) / 1e6 %}
              {% set stop_mhz = (b.freq_stop_hz or 0) / 1e6 %}
              <option value="{{ b.id }}">#{{ b.id }} Â· {{ b.name }} ({{ '%.1f' % start_mhz }}â€“{{ '%.1f' % stop_mhz }} MHz)</option>
              {% endfor %}
            </select>
            <div class="hint mt-1 text-xs" id="baselineHint">
              {% if has_baselines %}
                Select a baseline to tie each scan to persistent history.
              {% else %}
                Create a baseline before starting scans.
              {% endif %}
            </div>
          </div>
          <div class="field">
            <label>Baseline info</label>
            <div class="text-sm border border-slate-700/60 rounded-lg p-3 bg-slate-900/40" id="baselineSummary">
              {% if has_baselines %}
                Select a baseline to view metadata and recent activity.
              {% else %}
                No baselines yet. Use the create form to add one.
              {% endif %}
            </div>
          </div>
        </div>
        <input type="hidden" id="activeBaselineId" value="" />
      </div>

      <!-- Device -->
      <div>
        <div class="section-title">Device</div>
        <div class="subgrid">
          <div class="field"><label for="device_key">Select SDR</label>
            <select id="device_key" class="input" name="device_key"></select>
          </div>
          <div class="field"><label for="driver">Driver (hint)</label><input id="driver" class="input" name="driver" value="rtlsdr_native" /></div>
          <div class="field"><label for="gain">Gain (dB or auto)</label><input id="gain" class="input" name="gain" value="auto" placeholder="auto or number" /></div>
          <div class="field"><label for="samp_rate">Sample rate (Hz)</label><input id="samp_rate" class="input" name="samp_rate" value="2.4e6" inputmode="numeric" /></div>
          <div class="field"><label for="bandplan">Bandplan CSV (optional)</label><input id="bandplan" class="input" name="bandplan" value="" placeholder="bandplan.csv" /></div>
        </div>
        <div class="hint mt-1">Devices are enumerated from the controller. If empty, start the controller or attach an SDR.</div>
      </div>

      <div>
        <div class="section-title">Profile & Modes</div>
        <div class="subgrid">
          <div class="field">
            <label for="profile">Profile</label>
            <select id="profile" class="input" name="profile" {% if not has_profiles %}disabled{% endif %}>
              <option value="">(manual selection)</option>
              {% for prof in profile_list %}
              <option value="{{ prof.name }}">{{ prof.name }}</option>
              {% endfor %}
            </select>
            <div class="hint mt-1 text-xs" id="profileMeta">
              {% if has_profiles %}
                Select a profile to preview its range and defaults, or leave manual.
              {% else %}
                Profiles unavailable (controller offline?); enter parameters manually.
              {% endif %}
            </div>
          </div>
          <div class="field">
            <label for="scan_mode">Scan mode</label>
            <select id="scan_mode" class="input" name="scan_mode">
              <option value="normal">Normal scan</option>
              <option value="spur">Spur calibration</option>
            </select>
            <div class="hint mt-1 text-xs">Spur calibration populates the spur map and suppresses detections.</div>
          </div>
        </div>
      </div>

      <!-- Sweep -->
      <div>
        <div class="section-title">Sweep</div>
        <div class="subgrid">
          <div class="field"><label for="start">Start frequency (Hz)</label><input id="start" class="input" name="start" value="88e6" inputmode="numeric" required /></div>
          <div class="field"><label for="stop">Stop frequency (Hz)</label><input id="stop" class="input" name="stop" value="108e6" inputmode="numeric" required /></div>
          <div class="field"><label for="step">Step (Hz)</label><input id="step" class="input" name="step" value="2.4e6" inputmode="numeric" /></div>
          <div class="field"><label for="fft">FFT bins</label><input id="fft" class="input" name="fft" value="4096" inputmode="numeric" /></div>
          <div class="field"><label for="avg">Averaging (frames)</label><input id="avg" class="input" name="avg" value="8" inputmode="numeric" /></div>
          <div class="field"><label for="sleep_between_sweeps">Sleep between sweeps (s)</label><input id="sleep_between_sweeps" class="input" name="sleep_between_sweeps" value="0" inputmode="numeric" /></div>
        </div>
      </div>

      <!-- Detection -->
      <div>
        <div class="section-title">Detection</div>
        <div class="subgrid">
          <div class="field"><label for="threshold_db">Threshold (dB above noise)</label><input id="threshold_db" class="input" name="threshold_db" value="8" inputmode="numeric" /></div>
          <div class="field"><label for="guard_bins">Guard bins</label><input id="guard_bins" class="input" name="guard_bins" value="1" inputmode="numeric" /></div>
          <div class="field"><label for="min_width_bins">Min width (bins)</label><input id="min_width_bins" class="input" name="min_width_bins" value="2" inputmode="numeric" /></div>
          <div class="field"><label for="new_ema_occ">New EMA occ (0â€“1)</label><input id="new_ema_occ" class="input" name="new_ema_occ" value="0.02" inputmode="decimal" /></div>
        </div>
      </div>

      <!-- CFAR -->
      <div>
        <div class="section-title">CFAR</div>
        <div class="subgrid">
          <div class="field"><label for="cfar">CFAR mode</label>
            <select id="cfar" class="input" name="cfar">
              <option value="os" selected>os (ordered-statistics)</option>
              <option value="off">off</option>
            </select>
          </div>
          <div class="field"><label for="cfar_train">Train cells</label><input id="cfar_train" class="input" name="cfar_train" value="24" inputmode="numeric" /></div>
          <div class="field"><label for="cfar_guard">Guard cells</label><input id="cfar_guard" class="input" name="cfar_guard" value="4" inputmode="numeric" /></div>
          <div class="field"><label for="cfar_quantile">Quantile (0â€“1)</label><input id="cfar_quantile" class="input" name="cfar_quantile" value="0.75" inputmode="decimal" /></div>
          <div class="field"><label for="cfar_alpha_db">Alpha (dB, optional)</label><input id="cfar_alpha_db" class="input" name="cfar_alpha_db" value="" inputmode="decimal" placeholder="e.g. 2.5" /></div>
        </div>
        <div class="hint mt-1">If CFAR is <span class="chip">off</span>, fixed threshold is used.</div>
      </div>

      <!-- Output & Logs -->
      <div>
        <div class="section-title">Output & Logs</div>
        <div class="subgrid">
          <div class="field"><label for="db">Database path</label><input id="db" class="input" name="db" value="{{ db_path }}" /></div>
          <div class="field"><label for="jsonl">JSONL log (optional)</label><input id="jsonl" class="input" name="jsonl" value="" placeholder="file.jsonl" /></div>
          <label class="field"><label for="notify">Desktop notifications</label>
            <div class="flex items-center gap-2"><input id="notify" type="checkbox" name="notify" /> <span class="hint">Browser must allow notifications</span></div>
          </label>
        </div>
      </div>

      <!-- Run -->
      <div>
        <div class="section-title">Run</div>
        <div class="subgrid">
          <div class="field"><label for="mode">Mode</label>
            <select id="mode" class="input" name="mode">
              <option value="single">Single sweep</option>
              <option value="loop">Loop</option>
              <option value="repeat">Repeat N</option>
              <option value="duration">Duration</option>
            </select>
          </div>
          <div class="field"><label for="repeat">Repeat count</label><input id="repeat" class="input" name="repeat" value="" inputmode="numeric" placeholder="N" /></div>
          <div class="field"><label for="duration">Duration (e.g. 10m)</label><input id="duration" class="input" name="duration" value="" placeholder="e.g. 10m" /></div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mt-1">
        <button class="btn" type="submit">â–¶ Start</button>
        <button class="btn red" type="button" id="stopBtn">â–  Stop</button>
        <button class="btn" type="button" id="resetBtn">â†º Reset</button>
        <button class="btn" type="button" id="refreshDevicesBtn">ðŸ”„ Refresh devices</button>
      </div>
    </form>

    <div class="mt-4">
      <div class="text-xs muted mb-1">Live logs</div>
      <pre id="log" style="height:260px;overflow:auto;background:#0b1220;color:#c7f9ff;padding:8px;border-radius:.75rem"></pre>
    </div>
  </div>

  <div class="card">
    <h3 class="text-lg font-semibold mb-2">Create baseline</h3>
    <p class="text-sm muted mb-3">Define the antenna/location pair and frequency span your scans will maintain.</p>
    <form id="baselineForm" class="grid gap-3">
      <div class="field"><label for="baseline_name">Name</label><input id="baseline_name" class="input" name="name" placeholder="Roof VHF" required /></div>
      <div class="subgrid">
        <div class="field"><label for="baseline_freq_start_hz">Start (Hz)</label><input id="baseline_freq_start_hz" class="input" name="freq_start_hz" inputmode="numeric" placeholder="88e6" required /></div>
        <div class="field"><label for="baseline_freq_stop_hz">Stop (Hz)</label><input id="baseline_freq_stop_hz" class="input" name="freq_stop_hz" inputmode="numeric" placeholder="108e6" required /></div>
      </div>
      <div class="subgrid">
        <div class="field"><label for="baseline_location_lat">Latitude</label><input id="baseline_location_lat" class="input" name="location_lat" inputmode="decimal" placeholder="41.878" /></div>
        <div class="field"><label for="baseline_location_lon">Longitude</label><input id="baseline_location_lon" class="input" name="location_lon" inputmode="decimal" placeholder="-87.629" /></div>
      </div>
      <div class="subgrid">
        <div class="field"><label for="baseline_sdr_serial">SDR serial</label><input id="baseline_sdr_serial" class="input" name="sdr_serial" placeholder="rtl0001" /></div>
        <div class="field"><label for="baseline_antenna">Antenna</label><input id="baseline_antenna" class="input" name="antenna" placeholder="Discone" /></div>
      </div>
      <div class="field"><label for="baseline_notes">Notes</label><textarea id="baseline_notes" class="input" name="notes" rows="2" placeholder="Roof mount, 50ft LMR-400."></textarea></div>
      <div class="flex flex-wrap gap-2">
        <button class="btn" type="submit">ï¼‹ Create baseline</button>
        <button class="btn" type="button" id="baselineCopyRange">â†” Copy sweep range</button>
      </div>
      <div class="text-xs muted" id="baselineFormStatus">Baselines tie scans to one hardware/site. Re-run scans on the same baseline to build persistence.</div>
    </form>
  </div>

  <div class="card">
    <h3 class="text-lg font-semibold mb-2">Quick presets</h3>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
      <button class="btn" onclick="preset('FULL')">Full sweep (24â€“1766 MHz)</button>
      <button class="btn" onclick="preset('FM')">FM 88â€“108 MHz</button>
      <button class="btn" onclick="preset('VHF_AIR')">VHF Air 118â€“137</button>
      <button class="btn" onclick="preset('UHF_MILAIR')">UHF MilAir 225â€“400</button>
      <button class="btn" onclick="preset('2m')">2 m 144â€“146</button>
      <button class="btn" onclick="preset('70cm')">70 cm 430â€“440</button>
      <button class="btn" onclick="preset('MARINE')">Marine VHF 156â€“162.6</button>
      <button class="btn" onclick="preset('NOAA')">NOAA WX 162.4â€“162.55</button>
      <button class="btn" onclick="preset('AIS')">AIS 161.975â€“162.025</button>
      <button class="btn" onclick="preset('ADSB')">ADSâ€‘B 1090</button>
      <button class="btn" onclick="preset('PMR446')">PMR446 446.0â€“446.2</button>
      <button class="btn" onclick="preset('TETRA')">TETRA 390â€“430</button>
      <button class="btn" onclick="preset('LTE800')">LTE 800 DL 791â€“821</button>
    </div>

    <h3 class="text-lg font-semibold mt-6 mb-2">Scan parameter presets</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
      <button class="btn" onclick="scanPreset('FAST')">Fast Recon</button>
      <button class="btn" onclick="scanPreset('BALANCED')">Balanced</button>
      <button class="btn" onclick="scanPreset('FIDELITY')">High Fidelity Baseline</button>
    </div>

    <div class="mt-4 text-xs muted">Page auth token (optional) is stored as <code>SDRWATCH_TOKEN</code> in localStorage. Server uses its own controller token.</div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
const PROFILE_DATA = {{ profile_list|tojson }};
let BASELINE_DATA = {{ baseline_list|default([], true)|tojson }};
let BASELINE_SUMMARIES = {{ baseline_summary_map|default({}, true)|tojson }};
const TOKEN = localStorage.getItem("SDRWATCH_TOKEN") || "";
function authHeaders(isJson=true){
  const headers = {};
  if (TOKEN) headers["Authorization"] = "Bearer "+TOKEN;
  if (isJson) headers["Content-Type"] = "application/json";
  return headers;
}

const pill = document.getElementById('state-pill');
function setState(s){ pill.textContent = s; pill.className = 'pill ' + (s==='running'?'run':'idle'); }
let activeJob = null;
let lastJobId = null;
let cachedLogs = '';

function applyActiveResponse(resp){
  if(resp && resp.job){
    activeJob = resp.job;
    if(activeJob?.id){ lastJobId = activeJob.id; }
    setState(resp.state || 'running');
    return;
  }
  activeJob = null;
  if(resp && resp.state){ setState(resp.state); } else { setState('idle'); }
}

async function refreshActiveState(){
  try{
    const r = await fetch('/api/jobs/active', { headers: authHeaders(false) });
    if(!r.ok){ throw new Error('state fetch failed'); }
    const data = await r.json();
    applyActiveResponse(data);
    return data;
  }catch(err){
    console.error(err);
    return null;
  }
}

// Form persistence
const FORM_STORAGE_KEY = 'SDRWATCH_CTL_FORM';
const f = document.getElementById('ctl');
const profileSelect = document.getElementById('profile');
const profileMeta = document.getElementById('profileMeta');
const scanModeSelect = document.getElementById('scan_mode');
const baselineSelect = document.getElementById('baseline_select');
const baselineSummaryBox = document.getElementById('baselineSummary');
const baselineHiddenInput = document.getElementById('activeBaselineId');
const baselineHint = document.getElementById('baselineHint');
const baselineForm = document.getElementById('baselineForm');
const baselineFormStatus = document.getElementById('baselineFormStatus');
const baselineCopyRangeBtn = document.getElementById('baselineCopyRange');
const BASELINE_STORAGE_KEY = 'SDRWATCH_ACTIVE_BASELINE_ID';
let activeBaselineId = null;
const startBtn = f?.querySelector('button[type="submit"]');

function escapeHtml(str){
  if(str === undefined || str === null){ return ''; }
  return String(str).replace(/[&<>"']/g, (ch)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]));
}
function hzToMHz(val){
  const num = Number(val);
  if(!Number.isFinite(num)){ return 'â€”'; }
  return (num/1e6).toFixed(3);
}
function formatBaselineRange(record){
  if(!record) return 'â€”';
  return `${hzToMHz(record.freq_start_hz)}â€“${hzToMHz(record.freq_stop_hz)} MHz`;
}
function getBaselineSummaryEntry(id){
  if(!id){ return null; }
  return BASELINE_SUMMARIES?.[id] || BASELINE_SUMMARIES?.[String(id)] || null;
}
function renderBaselineSummary(record){
  if(!baselineSummaryBox){ return; }
  if(!record){
    baselineSummaryBox.textContent = 'Create or select a baseline to enable scans.';
    return;
  }
  const summary = getBaselineSummaryEntry(record.id) || {};
  const detCount = summary.persistent_detections || 0;
  const totalWindows = summary.total_windows || 0;
  const detectionLine = `${detCount} persistent detections Â· ${totalWindows} windows`;
  const lastUpdate = summary.last_update_utc || summary.last_detection_utc || 'No scans yet';
  const notes = record.notes ? `<div class="mt-2 text-xs text-slate-200">${escapeHtml(record.notes)}</div>` : '';
  baselineSummaryBox.innerHTML = `
    <div class="font-semibold text-base">${escapeHtml(record.name)} <span class="text-xs text-slate-400">#${record.id}</span></div>
    <div class="text-xs text-slate-300">${formatBaselineRange(record)}</div>
    <div class="text-xs text-slate-400">Created ${escapeHtml(record.created_at || 'â€”')}</div>
    <div class="text-xs text-cyan-300 mt-2">${escapeHtml(detectionLine)}</div>
    <div class="text-xs text-lime-300">Last update: ${escapeHtml(lastUpdate)}</div>
    ${notes}
  `;
}
function renderBaselineOptions(){
  if(!baselineSelect){ return; }
  const current = String(baselineSelect.value || '');
  baselineSelect.innerHTML = '';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = BASELINE_DATA.length ? '(select baseline)' : '(no baselines yet)';
  baselineSelect.appendChild(placeholder);
  for(const b of BASELINE_DATA){
    const opt = document.createElement('option');
    opt.value = b.id;
    opt.textContent = `#${b.id} Â· ${b.name} (${hzToMHz(b.freq_start_hz)}â€“${hzToMHz(b.freq_stop_hz)} MHz)`;
    baselineSelect.appendChild(opt);
  }
  baselineSelect.disabled = BASELINE_DATA.length === 0;
  if(current && BASELINE_DATA.some(b => String(b.id) === current)){
    baselineSelect.value = current;
  }
}
function updateStartButtonState(){
  if(startBtn){
    const enabled = Boolean(activeBaselineId);
    startBtn.disabled = !enabled;
    startBtn.classList.toggle('opacity-50', !enabled);
  }
  if(baselineHint){
    baselineHint.textContent = activeBaselineId ? 'Baseline selected. Jobs will include this baseline_id.' : 'Create or select a baseline before starting scans.';
  }
}
function setActiveBaseline(value, opts = {}){
  const persist = opts.persist !== false;
  const strVal = value === undefined || value === null ? '' : String(value);
  const record = BASELINE_DATA.find(b => String(b.id) === strVal);
  if(!record){
    activeBaselineId = null;
    if(baselineHiddenInput){ baselineHiddenInput.value = ''; }
    if(baselineSelect && baselineSelect.value !== ''){ baselineSelect.value = ''; }
    if(persist){ localStorage.removeItem(BASELINE_STORAGE_KEY); }
    renderBaselineSummary(null);
    updateStartButtonState();
    return;
  }
  activeBaselineId = record.id;
  if(baselineHiddenInput){ baselineHiddenInput.value = String(record.id); }
  if(baselineSelect && baselineSelect.value !== String(record.id)){
    baselineSelect.value = String(record.id);
  }
  if(persist){ localStorage.setItem(BASELINE_STORAGE_KEY, String(record.id)); }
  renderBaselineSummary(record);
  updateStartButtonState();
}
async function fetchBaselines(){
  try{
    const resp = await fetch('/api/baselines', { headers: authHeaders(false) });
    if(!resp.ok){ throw new Error('failed to fetch baselines'); }
    const data = await resp.json();
    if(Array.isArray(data.baselines)){ BASELINE_DATA = data.baselines; }
    if(data.summaries){ BASELINE_SUMMARIES = data.summaries; }
    renderBaselineOptions();
    if(activeBaselineId && !BASELINE_DATA.some(b => Number(b.id) === Number(activeBaselineId))){
      setActiveBaseline(null, {persist:false});
    }else if(activeBaselineId){
      setActiveBaseline(String(activeBaselineId), {persist:false});
    }
  }catch(err){ console.error(err); }
}
renderBaselineOptions();
const savedBaselineId = localStorage.getItem(BASELINE_STORAGE_KEY);
if(savedBaselineId && BASELINE_DATA.some(b => String(b.id) === savedBaselineId)){
  setActiveBaseline(savedBaselineId, {persist:false});
}else if(BASELINE_DATA.length){
  setActiveBaseline(String(BASELINE_DATA[0].id), {persist:false});
}else{
  setActiveBaseline(null, {persist:false});
}
baselineSelect?.addEventListener('change', (ev)=>{
  setActiveBaseline(ev.target.value || '', {persist:true});
});
baselineCopyRangeBtn?.addEventListener('click', ()=>{
  if(!baselineForm || !f) return;
  baselineForm.freq_start_hz.value = f.start?.value || '';
  baselineForm.freq_stop_hz.value = f.stop?.value || '';
  if(baselineFormStatus){ baselineFormStatus.textContent = 'Copied sweep range into the baseline form.'; }
});
baselineForm?.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  if(!baselineForm){ return; }
  if(baselineFormStatus){ baselineFormStatus.textContent = 'Creating baseline...'; }
  const fd = new FormData(baselineForm);
  const payload = Object.fromEntries(fd.entries());
  const numericFields = ['freq_start_hz','freq_stop_hz','location_lat','location_lon','bin_hz'];
  numericFields.forEach((field)=>{
    if(payload[field] !== undefined && payload[field] !== ''){
      payload[field] = Number(payload[field]);
    } else {
      delete payload[field];
    }
  });
  try{
    const resp = await fetch('/api/baselines', { method:'POST', headers: authHeaders(), body: JSON.stringify(payload) });
    const data = await resp.json().catch(()=>({}));
    if(!resp.ok){
      const errMsg = data?.error || data?.detail || 'baseline create failed';
      throw new Error(errMsg);
    }
    if(data.summaries){ BASELINE_SUMMARIES = data.summaries; }
    const created = data.baseline;
    if(created){
      const existingIdx = BASELINE_DATA.findIndex(b => Number(b.id) === Number(created.id));
      if(existingIdx >= 0){
        BASELINE_DATA[existingIdx] = created;
      } else {
        BASELINE_DATA = [created, ...BASELINE_DATA];
      }
      renderBaselineOptions();
      setActiveBaseline(String(created.id));
    }else{
      await fetchBaselines();
    }
    baselineForm.reset();
    if(baselineFormStatus){ baselineFormStatus.textContent = 'Baseline created. It is now active.'; }
  }catch(err){
    console.error(err);
    if(baselineFormStatus){ baselineFormStatus.textContent = `Failed to create baseline: ${err.message}`; }
  }
});
fetchBaselines();

function saveForm(){
  const fd = new FormData(f);
  const obj = Object.fromEntries(fd.entries());
  obj.notify = f.notify?.checked ? 'on' : '';
  localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(obj));
}
function loadForm(){
  try{
    const obj = JSON.parse(localStorage.getItem(FORM_STORAGE_KEY)||'{}');
    for(const [k,v] of Object.entries(obj)){
      const el = f.elements[k];
      if(!el) continue;
      if(el.type==='checkbox'){
        el.checked = (v==='on');
      } else {
        el.value = v;
      }
    }
  }catch(e){}
}
function updateProfileMeta(){
  if(!profileMeta){ return; }
  if(!profileSelect || profileSelect.disabled || PROFILE_DATA.length === 0){
    profileMeta.textContent = PROFILE_DATA.length === 0 ? 'Profiles unavailable (controller offline?).' : 'Custom/manual parameters.';
    return;
  }
  const selected = profileSelect.value;
  if(!selected){
    profileMeta.textContent = 'Custom/manual parameters.';
    return;
  }
  const prof = PROFILE_DATA.find(p => String(p.name) === selected);
  if(!prof){
    profileMeta.textContent = 'Custom/manual parameters.';
    return;
  }
  const span = `${(prof.f_low_hz/1e6).toFixed(3)}â€“${(prof.f_high_hz/1e6).toFixed(3)} MHz`;
  const samp = prof.samp_rate ? `${(Number(prof.samp_rate)/1e6).toFixed(2)} MS/s` : null;
  const parts = [span];
  if(samp){ parts.push(`samp ${samp}`); }
  parts.push(`FFT ${prof.fft}`, `avg ${prof.avg}`);
  if(prof.gain_db !== undefined && prof.gain_db !== null){
    parts.push(`gain ${prof.gain_db} dB`);
  }
  profileMeta.textContent = parts.join(' Â· ');
}

f.addEventListener('input', saveForm);
profileSelect?.addEventListener('change', ()=>{ updateProfileMeta(); saveForm(); });
scanModeSelect?.addEventListener('change', saveForm);
document.getElementById('resetBtn')?.addEventListener('click', ()=>{ localStorage.removeItem(FORM_STORAGE_KEY); location.reload(); });
loadForm();
updateProfileMeta();

// Devices
async function loadDevices(){
  try{
    const r = await fetch('/ctl/devices');
    const data = await r.json();
    const sel = document.getElementById('device_key');
    sel.innerHTML = '';
    if (!Array.isArray(data)) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = `(${data?.error || 'controller_error'})`;
      sel.appendChild(opt);
      console.error('Controller error:', data);
      return;
    }
    if (data.length===0){
      const opt = document.createElement('option'); opt.value=''; opt.textContent='(no devices)'; sel.appendChild(opt);
    } else {
      for(const d of data){
        const opt = document.createElement('option');
        opt.value = d.key; opt.textContent = d.label + ' [' + d.kind + ']';
        sel.appendChild(opt);
      }
    }
  }catch(e){ console.error(e); }
}
loadDevices();
document.getElementById('refreshDevicesBtn')?.addEventListener('click', loadDevices);

// Presets
function preset(k){
  f.samp_rate.value = '2.4e6'; f.fft.value = '4096'; f.avg.value = '8'; f.gain.value = f.gain.value || 'auto';
  if(k==='FULL'){ f.start.value='24e6'; f.stop.value='1766e6'; f.step.value='2.4e6'; }
  if(k==='FM'){ f.start.value='88e6'; f.stop.value='108e6'; f.step.value='2.4e6'; }
  if(k==='VHF_AIR'){ f.start.value='118e6'; f.stop.value='137e6'; f.step.value='500e3'; }
  if(k==='UHF_MILAIR'){ f.start.value='225e6'; f.stop.value='400e6'; f.step.value='2.4e6'; }
  if(k==='2m'){ f.start.value='144e6'; f.stop.value='146e6'; f.step.value='1.2e6'; }
  if(k==='70cm'){ f.start.value='430e6'; f.stop.value='440e6'; f.step.value='2.4e6'; }
  if(k==='MARINE'){ f.start.value='156e6'; f.stop.value='162.6e6'; f.step.value='1.2e6'; }
  if(k==='NOAA'){ f.start.value='162.4e6'; f.stop.value='162.55e6'; f.step.value='100e3'; }
  if(k==='AIS'){ f.start.value='161.975e6'; f.stop.value='162.025e6'; f.step.value='200e3'; }
  if(k==='ADSB'){ f.start.value='1089e6'; f.stop.value='1091e6'; f.step.value='2.4e6'; }
  if(k==='PMR446'){ f.start.value='446.0e6'; f.stop.value='446.2e6'; f.step.value='200e3'; }
  if(k==='TETRA'){ f.start.value='390e6'; f.stop.value='430e6'; f.step.value='2.4e6'; }
  if(k==='LTE800'){ f.start.value='791e6'; f.stop.value='821e6'; f.step.value='2.4e6'; }
  saveForm();
}
function scanPreset(p) {
  if (p === 'FAST') { f.fft.value = '1024'; f.avg.value = '2'; f.step.value = '2.4e6'; f.samp_rate.value = '2.4e6'; f.threshold_db.value = '10'; f.guard_bins.value = '1'; f.min_width_bins.value = '2'; }
  if (p === 'BALANCED') { f.fft.value = '4096'; f.avg.value = '8'; f.step.value = '1.2e6'; f.samp_rate.value = '2.4e6'; f.threshold_db.value = '8'; f.guard_bins.value = '1'; f.min_width_bins.value = '2'; }
  if (p === 'FIDELITY') { f.fft.value = '16384'; f.avg.value = '32'; f.step.value = '600e3'; f.samp_rate.value = '2.4e6'; f.threshold_db.value = '6'; f.guard_bins.value = '1'; f.min_width_bins.value = '2'; }
  saveForm();
}

// Start/Stop via webapp proxy -> controller
f.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!activeBaselineId){
    alert('Create or select a baseline before starting a scan.');
    return;
  }
  const fd = new FormData(e.target);
  const body = Object.fromEntries(fd.entries());
  const maybeNum = (k)=>{ if(body[k]!==undefined && body[k]!=='' && !isNaN(Number(body[k]))) body[k] = Number(body[k]); };
  ['start','stop','step','samp_rate','fft','avg','threshold_db','guard_bins','min_width_bins','cfar_train','cfar_guard','cfar_quantile','cfar_alpha_db','new_ema_occ','sleep_between_sweeps','repeat'].forEach(maybeNum);
  if(body.mode==='loop'){ body.loop = true; }
  if(body.mode==='repeat'){ body.repeat = body.repeat||1; }
  delete body.mode;
  if(body.notify==='on'){ body.notify = true; } else { delete body.notify; }
  const profile = (body.profile || '').toString().trim();
  if(profile){ body.profile = profile; } else { delete body.profile; }
  const scanMode = (body.scan_mode || '').toString();
  if(scanMode === 'spur'){
    body.spur_calibration = true;
  } else {
    delete body.spur_calibration;
  }
  delete body.scan_mode;

  const device_key = body.device_key; delete body.device_key;
  const payload = { device_key, label: body.label || 'web', baseline_id: Number(activeBaselineId), params: body };

  try{
    const r = await fetch('/api/jobs', { method:'POST', headers: authHeaders(), body: JSON.stringify(payload) });
    const data = await r.json();
    if(!r.ok){ throw new Error(data?.error || 'start failed'); }
    applyActiveResponse(data);
  }catch(err){
    console.error(err);
    alert('Failed to start scan: ' + err.message);
  }
});
document.getElementById('stopBtn')?.addEventListener('click', async ()=>{
  try{
    if(!activeJob){ await refreshActiveState(); }
    if(!activeJob?.id){ setState('idle'); return; }
    const r = await fetch(`/api/jobs/${encodeURIComponent(activeJob.id)}`, { method:'DELETE', headers: authHeaders() });
    if(!r.ok){ throw new Error('stop failed'); }
    applyActiveResponse({state:'idle'});
  }catch(err){ console.error(err); }
});

// Poll status
async function poll(){
  await refreshActiveState();
  setTimeout(poll, 1000);
}
poll();

// Logs
const log = document.getElementById('log');
let userScrolling = false;
log.addEventListener('scroll', ()=>{
  // Consider user as scrolling if not within 24px of bottom
  const nearBottom = (log.scrollHeight - log.scrollTop - log.clientHeight) < 24;
  userScrolling = !nearBottom;
});
async function pollLogs(){
  const jobId = activeJob?.id || lastJobId;
  if(!jobId){
    setTimeout(pollLogs, 1000);
    return;
  }
  try{
    const r = await fetch(`/api/jobs/${encodeURIComponent(jobId)}/logs?tail=500`, { headers: authHeaders(false) });
    if(r.ok){
      const t = await r.text();
      if(t && t.length > 0){ cachedLogs = t; }
      log.textContent = cachedLogs;
      if (!userScrolling) { log.scrollTop = log.scrollHeight; }
    }
  }catch(e){ console.error(e); }
  setTimeout(pollLogs, 1000);
}
pollLogs();
</script>
{% endblock %}
